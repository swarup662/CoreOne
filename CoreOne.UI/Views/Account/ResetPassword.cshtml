@{
    Layout = "_LoginLayout";
}
<div class="container mt-4">
    <h4>Reset Password</h4>
    <input type="password" id="newPwd" class="form-control mb-2" placeholder="New password" />
    <button id="btnReset" class="btn btn-success">Reset</button>
    <div id="timer" class="mt-2 text-danger"></div>
</div>

<script>
    const token = new URLSearchParams(window.location.search).get('token');
    let userId = 0;

    // 🔹 Validate the token first
    $.ajax({
        url: '/Account/ValidateResetToken?token=' + token,
        method: 'GET',
        success: function (r) {
            if (!r.success) {
                $("#timer").text(r.message || "Invalid or expired token");
                $("#btnReset").prop('disabled', true);
                return;
            }

            // Store userID for password reset
            userId = r.userID;

            // 🔹 Parse expiry and start timer
            const expiry = new Date(r.expiresAt);
            const updateTimer = () => {
                const now = new Date();
                const remaining = Math.floor((expiry - now) / 1000);

                if (remaining <= 0) {
                    $("#timer").text("Link expired");
                    $("#btnReset").prop('disabled', true);
                    clearInterval(timer);
                    return;
                }

                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                $("#timer").text(`Link expires in ${m}:${s.toString().padStart(2, '0')}`);
            };

            updateTimer();
            const timer = setInterval(updateTimer, 1000);

            // 🔹 Handle password reset click
            $("#btnReset").click(function () {
                const newPwd = $("#newPwd").val().trim();
                if (newPwd === "") {
                    alert("Please enter a new password.");
                    return;
                }

                const payload = {
                    userID: userId,
                    newPassword: newPwd,
                    token: token
                };

                $.ajax({
                    url: '/Account/ResetPassword',
                    method: 'POST',
                    data: JSON.stringify(payload),
                    contentType: 'application/json',
                    success: function (resp) {
                        if (resp.success) {
                            alert(resp.message || "Password reset successful.");
                            window.location.href = "/Account/Login"; // redirect to login page
                        } else {
                            alert(resp.message || "Password reset failed.");
                        }
                    },
                    error: function () {
                        alert("Something went wrong. Please try again.");
                    }
                });
            });
        },
        error: function () {
            $("#timer").text("Unable to validate token.");
            $("#btnReset").prop('disabled', true);
        }
    });
</script>
