@model List<CoreOne.DOMAIN.Models.UserAccessViewModel>

@{
    Layout = "_AppLayout";
    ViewData["Title"] = "Select Company & Application";
    var userId = TempData["userId"];
    TempData.Keep("userId");
}

<div class="container mt-5">
    <h3 class="mb-4 text-center fw-bold">Select Company & Application</h3>

    <!-- Company Selection -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-6">
            <label for="companyDropdown" class="form-label fw-bold">Select Company:</label>
            <select id="companyDropdown" class="form-select shadow-sm">
                <option value="">-- Select Company --</option>
            </select>
        </div>
    </div>

    <!-- Applications Section -->
    <div id="appSection" style="display:none;">
        <h5 class="text-center mb-3 fw-semibold">Available Applications</h5>
        <div id="appGrid" class="row justify-content-center g-3"></div>
    </div>

    <!-- Loader -->
    <div id="loader" class="text-center mt-4" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- ✅ Modern Card Styles -->
<style>
    .app-card {
        transition: all 0.25s ease;
        border-radius: 12px;
        cursor: pointer;
        background: #fff;
        border: 2px solid transparent;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

        .app-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
        }

        .app-card.selected {
            outline: 3px solid #007bff;
        }

    .app-icon {
        font-size: 2.2rem;
        margin-bottom: 0.3rem;
    }

    .app-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: #333;
        text-transform: capitalize;
        margin: 0;
    }

    .app-card:hover .app-name {
        color: #000;
    }

    /* Smooth fade-in animation */
    #appGrid {
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(5px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            const userId = '@userId';

            // 🔹 Load Companies
            $.getJSON('/Account/GetCompanies', function (companies) {
                $.each(companies, function (i, company) {
                    $('#companyDropdown').append(
                        $('<option>', {
                            value: company.companyID,
                            text: company.companyName
                        })
                    );
                });
            });

            // 🔹 When Company Changes
            $('#companyDropdown').change(function () {
                const companyId = $(this).val();
                $('#appGrid').empty();
                $('#appSection').hide();
                $('#loader').show();

                if (!companyId) {
                    $('#loader').hide();
                    return;
                }

                // Fetch applications for selected company
                $.getJSON('/Account/GetApplicationsByCompany?companyId=' + companyId)
                    .done(function (apps) {
                        console.log("Apps received before filtering:", apps);
                        $('#appGrid').empty();

                        if (!apps.length) {
                            $('#appGrid').append('<p class="text-center text-muted">No applications found for this company.</p>');
                            $('#loader').hide();
                            $('#appSection').show();
                            return;
                        }

                        // ✅ Remove duplicates (same ApplicationID)
                        const uniqueApps = [];
                        const seen = new Set();

                        $.each(apps, function (i, app) {
                            if (!seen.has(app.applicationID)) {
                                seen.add(app.applicationID);
                                uniqueApps.push(app);
                            }
                        });

                        console.log("Filtered unique apps:", uniqueApps);

                        // ✅ Render clean, short cards
                        $.each(uniqueApps, function (i, app) {
                            const color = app.colorCode || '#007bff';
                            const icon = app.icon || 'fa-solid fa-cube';

                            const card = `
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="app-card shadow-sm text-center border-0"
                                         data-app='${JSON.stringify(app)}'
                                         style="border-color:${color};">
                                        <i class="${icon} app-icon" style="color:${color};"></i>
                                        <p class="app-name">${app.applicationName}</p>
                                    </div>
                                </div>`;
                            $('#appGrid').append(card);
                        });

                        $('#loader').hide();
                        $('#appSection').show();
                        $('#appGrid').fadeIn(200);
                    })
                    .fail(function (xhr) {
                        $('#loader').hide();
                        alert("Error fetching applications: " + xhr.statusText);
                    });
            });

            // 🔹 When Clicking an App Card
            $(document).on('click', '.app-card', function () {
                const app = $(this).data('app');
                const companyId = $('#companyDropdown').val();

                $('.app-card').removeClass('selected');
                $(this).addClass('selected');

                // Auto-detect environment (domain vs port)
                const currentHost = window.location.hostname.toLowerCase();
                let urlType = (currentHost === "localhost" || /^[0-9.]+$/.test(currentHost)) ? "port" : "domain";

                const payload = {
                    UserID: parseInt(userId),
                    CompanyID: parseInt(companyId),
                    ApplicationID: parseInt(app.applicationID),
                    RoleID: parseInt(app.roleID || app.defaultRoleID),
                    UrlType: urlType
                };

                console.log("Launching app:", payload);

                $('#loader').show();

                $.ajax({
                    url: '/Account/LaunchApp',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        $('#loader').hide();
                        if (response.success) {
                            window.location.href = response.redirectUrl;
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function () {
                        $('#loader').hide();
                        alert('Something went wrong while launching the application.');
                    }
                });
            });
        });
    </script>
}
