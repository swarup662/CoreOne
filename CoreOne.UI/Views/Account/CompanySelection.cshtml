@model List<CoreOne.DOMAIN.Models.UserAccessViewModel>

@{
    Layout = "_AppLayout";
    ViewData["Title"] = "Select Company & Application";
    var userId = TempData["userId"];
    TempData.Keep("userId");
}

<div class="container mt-5">
    <h3 class="mb-4 text-center fw-bold">Select Company & Application</h3>

    <!-- Company Selection -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-6">
            <label for="companyDropdown" class="form-label fw-bold">Select Company:</label>
            <select id="companyDropdown" class="form-select shadow-sm">
                <option value="">-- Select Company --</option>
            </select>
        </div>
    </div>

    <!-- Applications Section -->
    <div id="appSection" style="display:none;">
        <h5 class="text-center mb-3 fw-semibold">Available Applications</h5>
        <div id="appGrid" class="row justify-content-center g-3"></div>
    </div>

    <!-- Loader -->
    <div id="loader" class="text-center mt-4" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- ✅ Odoo-Style Tile Design -->
<style>
    .app-card {
        position: relative;
        width: 100%;
        height: 140px;
        border-radius: 18px;
        background: var(--app-color, #6c63ff);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: white;
        text-align: center;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

        .app-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.2);
        }

    .app-icon {
        font-size: 2.5rem;
        margin-bottom: 0.4rem;
        color: #fff;
    }

    .app-name {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        text-transform: capitalize;
        margin: 0;
    }

    #appGrid {
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- ✅ Include SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            const userId = '@userId';

            // 🔹 Load Companies
            $.getJSON('/Account/GetCompanies', function (companies) {
                $.each(companies, function (i, company) {
                    $('#companyDropdown').append(
                        $('<option>', {
                            value: company.companyID,
                            text: company.companyName
                        })
                    );
                });
            });

            // 🔹 When Company Changes
            $('#companyDropdown').change(function () {
                const companyId = $(this).val();
                $('#appGrid').empty();
                $('#appSection').hide();
                $('#loader').show();

                if (!companyId) {
                    $('#loader').hide();
                    return;
                }

                $.getJSON('/Account/GetApplicationsByCompany?companyId=' + companyId)
                    .done(function (apps) {
                        $('#appGrid').empty();

                        if (!apps.length) {
                            $('#appGrid').append('<p class="text-center text-muted">No applications found for this company.</p>');
                            $('#loader').hide();
                            $('#appSection').show();
                            return;
                        }

                        // Remove duplicate apps (same ApplicationID)
                        const uniqueApps = [];
                        const seen = new Set();

                        $.each(apps, function (i, app) {
                            if (!seen.has(app.applicationID)) {
                                seen.add(app.applicationID);
                                uniqueApps.push(app);
                            }
                        });

                        // Render app tiles
                        $.each(uniqueApps, function (i, app) {
                            const color = app.colorCode || '#6c63ff';
                            const icon = app.icon || 'fa-solid fa-cube';

                            const card = `
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="app-card"
                                         data-app='${JSON.stringify(app)}'
                                         style="--app-color:${color}; background:${color};">
                                        <i class="${icon} app-icon"></i>
                                        <p class="app-name">${app.applicationName}</p>
                                    </div>
                                </div>`;
                            $('#appGrid').append(card);
                        });

                        $('#loader').hide();
                        $('#appSection').show();
                        $('#appGrid').fadeIn(200);
                    })
                    .fail(function (xhr) {
                        $('#loader').hide();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Unable to load applications: ' + xhr.statusText
                        });
                    });
            });

            // 🔹 When Clicking an App Card
            $(document).on('click', '.app-card', function () {
                const app = $(this).data('app');
                const companyId = $('#companyDropdown').val();

                $('.app-card').removeClass('selected');
                $(this).addClass('selected');

                const currentHost = window.location.hostname.toLowerCase();
                let urlType = (currentHost === "localhost" || /^[0-9.]+$/.test(currentHost)) ? "port" : "domain";

                const payload = {
                    UserID: parseInt(userId),
                    CompanyID: parseInt(companyId),
                    ApplicationID: parseInt(app.applicationID),
                    RoleID: parseInt(app.roleID || app.defaultRoleID),
                    UrlType: urlType
                };

                $('#loader').show();

                $.ajax({
                    url: '/Account/LaunchApp',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        $('#loader').hide();

                        if (response.success && response.redirectUrl) {
                            // ✅ Verify URL exists
                            $.ajax({
                                url: response.redirectUrl,
                                type: 'HEAD',
                                timeout: 5000,
                                success: function () {
                                    window.location.href = response.redirectUrl; // open in same tab
                                },
                                error: function () {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Application not exist',
                                        text: 'The application link is invalid or unreachable.'
                                    });
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Application not exist',
                                text: 'The application link could not be found.'
                            });
                        }
                    },
                    error: function () {
                        $('#loader').hide();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Something went wrong while launching the application.'
                        });
                    }
                });
            });
        });
    </script>
}
