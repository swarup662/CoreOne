@using CoreOne.DOMAIN.Models
@using Newtonsoft.Json
@model CoreOne.DOMAIN.Models.UserCreation

@{
    ViewData["Title"] = "User Creation";
    var users = ViewBag.Users as List<UserCreation> ?? new();
    int totalRecords = ViewBag.TotalRecords ?? 0;
    int pageNumber = ViewBag.PageNumber ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    string sortColumn = ViewBag.SortColumn ?? "";
    string sortDir = ViewBag.SortDir ?? "ASC";
    string search = ViewBag.Search ?? "";
    string searchCol = ViewBag.SearchCol ?? "";
}

<style>
    #addUserModal .modal-content {
        border-radius: 1rem;
        transition: all 0.3s ease;
    }

    #addUserModal .modal-header {
        background: linear-gradient(135deg, #007bff, #0056d2);
    }

    #addUserModal img.object-fit-cover {
        object-fit: cover;
    }

</style>
<link href="~/css/usercreation.css" rel="stylesheet" />
<script>
    async function loadUserPhotoByFilePath(filePath, elementId) {
        // Use the same logic as loadProfilePhoto
        const img = document.getElementById(elementId);
        const defaultSrc = "/images/default-user.png";

        if (!img) return;

        // Handle invalid, null, or empty path
        if (!filePath || filePath.trim() === "" || filePath === "null" || filePath === "undefined") {
            img.src = defaultSrc;
            return;
        }

        try {
            // Use your existing API exactly as in loadProfilePhoto
            const resp = await fetch(`/api/FileUpload/viewSaved?filePath=${encodeURIComponent(filePath)}`);
            if (!resp.ok) throw new Error("Photo not found");

            const blob = await resp.blob();
            const blobUrl = URL.createObjectURL(blob);

            img.src = blobUrl;
        } catch (err) {
            console.error("Error loading user photo:", err);
            img.src = defaultSrc;
        }
    }
</script>



<div class="container-fluid  p-2" style="background:rgba(255, 255, 255, 0.08);">



    <div class="row" style="margin-top: -19px; margin-bottom: -6px;">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Authorization</a></li>
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Dashboard</a></li>

                    </ol>
                </div>
                <h4 class="page-title">User Creation</h4>
            </div>
        </div>
    </div>



    <div class="card" style="background:rgba(255, 255, 255, 0.08);border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
        <div class="card-body">

            <div class="row align-items-center p-2 mb-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
                <div class="col-md-3 d-flex gap-2">
                    <button type="button" class="btn btn-blue waves-effect waves-light" style="background: linear-gradient(135deg, #8173fa, #5a48e5);border-radius: 11px;"
                            onclick="window.location.href='/UserCreation/Index'">
                        <i class="mdi mdi-refresh-circle"></i> Refresh
                    </button>
                    <!-- VIEW TOGGLE BUTTONS ADDED -->
                    <button id="btnGridView" class="btn btn-outline-light" onclick="toggleView('grid')">
                        <i class="mdi mdi-view-grid"></i>
                    </button>

                    <button id="btnListView" class="btn btn-outline-light" onclick="toggleView('list')" style="display:none;">
                        <i class="mdi mdi-format-list-bulleted"></i>
                    </button>

                </div>
                <div class="col-md-5">
                </div>

                <div class="col-md-4 ms-auto d-flex justify-content-end">


                    <has-permission module-id="4" action-id="1">


                        <button type="button" class="btn btn-success float-end" id="btnAddUser" data-bs-toggle="modal" data-bs-target="#addUserModal" style="background: linear-gradient(135deg, #13dc72, #004993);    border-radius: 11px;">
                            <i class="mdi mdi-plus-circle"></i> Create User
                        </button>
                    </has-permission>

                </div>
            </div>

            <div class="row align-items-center p-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">

                <div class="col-md-4">
                    <input type="text" id="search" value="@search" class="form-control" placeholder="Search..." style="border-radius: 11px;  background: linear-gradient(135deg, #f8fbff, #ffffff);" />
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="searchCol" style="  background: linear-gradient(135deg, #f8fbff, #ffffff);   border-radius: 11px;">
                        <option value="UserName" selected> Name</option>
                        <option value="Email">Email</option>
                        <option value="PhoneNumber">Phone</option>
                        <option value="GenderName">Gender</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="activeStatus" style="  background: linear-gradient(135deg, #f8fbff, #ffffff);   border-radius: 11px;">
                        <option value="">All Status</option>
                        <option value="1">Active</option>
                        <option value="2">Blocked</option>
                        <option value="0">Deactivated</option>
                    </select>

                </div>
                <!-- Page Size Dropdown (like Role) -->
                <div class="col-md-2">

                    <button id="btnSearch" class="btn btn-success rounded-pill ms-2">
                        <i class="mdi mdi-magnify"></i> Search
                    </button>


                </div>
                <div class="col-md-2 ms-auto d-flex justify-content-end">
                    <select class="form-select" id="pageSize" style="border-radius: 11px; background: linear-gradient(135deg, #f8fbff, #ffffff);">
                        @{
                            int[] pageSizes = new int[] { 1, 10, 20, 50, 100 };
                            foreach (var size in pageSizes)
                            {
                                <option value="@size" selected="@(size == pageSize)">@size</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="row align-items-center p-2 mt-2 mb-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">

                <div id="listViewContainer" class="row" style="display:block;">
            <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm small mt-2">
                        <thead class="table-light text-dark">
                            <tr>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black">Sl No.</th>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black">Profile</th>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black" onclick="sortTable('UserName')">
                                    Name @Html.Raw(sortColumn == "UserName" ? (sortDir == "ASC" ? "▲" : "▼") : "")
                                </th>
                                <th class="text-start sortable" onclick="sortTable('Email')">
                                    Email @Html.Raw(sortColumn == "Email" ? (sortDir == "ASC" ? "▲" : "▼") : "")
                                </th>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black">Phone</th>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black" onclick="sortTable('RoleName')">
                                    Role @Html.Raw(sortColumn == "RoleName" ? (sortDir == "ASC" ? "▲" : "▼") : "")
                                </th>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black" onclick="sortTable('GenderName')">
                                    Gender @Html.Raw(sortColumn == "GenderName" ? (sortDir == "ASC" ? "▲" : "▼") : "")
                                </th>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black">Status</th>
                                <th class="justify-content-between align-items-center text-decoration-none" style="color:black">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int count = ((pageNumber - 1) * pageSize) + 1;
                            }
                            @if (users.Any())
                            {
                                foreach (var user in users)
                                {
                                    <tr class="align-middle">
                                        <td class="text-center">@count</td>
                                        <td class="text-center">
                                            <img id="userPhoto_@user.UserID"
                                                 src="/images/default-user.png"
                                                 alt="Profile"
                                                 class="rounded-circle"
                                                 style="width:50px; height:50px; object-fit:cover; border:1px solid #ddd;">
                                        </td>
                                        <td class="text-start fw-semibold">@user.UserName</td>
                                        <td class="text-start">@user.Email</td>
                                        <td class="text-start">@user.PhoneNumber</td>
                                        <td class="text-start">@user.RoleName</td>
                                        <td class="text-start">@user.GenderName</td>
                                        <td class="text-center">
                                            @{
                                                var status = user.ActiveFlag switch
                                                {
                                                    1 => "Active",

                                                    0 => "Deactivated",
                                                    _ => "Unknown"
                                                };
                                                var badgeClass = user.ActiveFlag == 1 ? "bg-success" :
                                                user.ActiveFlag == 0 ? "bg-danger" :
                                                "bg-secondary";
                                            }
                                            <span class="badge @badgeClass fw-semibold">@status</span>

                                        </td>
                                        <td class="text-center">
                                            <div class="d-flex justify-content-center align-items-center gap-2">
                                                <!-- Edit Icon -->
                                                <has-permission module-id="4" action-id="2">
                                                    <i class="mdi mdi-square-edit-outline cursor-pointer"
                                                       style="font-size: 1.3rem;color:rebeccapurple"
                                                       title="Edit User" 
                                                       onclick="editUser(@user.UserID)"></i>
                                                </has-permission>

                                                <!-- View Icon -->
                                                <has-permission module-id="4" action-id="4">
                                                    <i class="bi bi-eye-fill text-primary cursor-pointer"
                                                       style="font-size: 1.3rem;"
                                                       title="View User"
                                                       onclick="viewUser(@user.UserID)"></i>
                                                </has-permission>

                                                <!-- Dropdown Three-Dot Icon -->
                                                <div class="dropdown">
                                                    <i class="mdi mdi-dots-vertical text-secondary cursor-pointer"
                                                       style="font-size: 1.5rem;"
                                                       id="dropdownMenuButton@user.UserID"
                                                       data-bs-toggle="dropdown"
                                                       aria-expanded="false"
                                                       title="More Actions"></i>
                                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton@user.UserID">
                                                        @if (user.ActiveFlag == 0)
                                                        {
                                                            <has-permission module-id="4" action-id="10">
                                                                <li>
                                                                    <a class="dropdown-item" href="javascript:void(0);" onclick="activateUser(@user.UserID)">
                                                                        <i class="mdi mdi-lock-open-outline me-1"></i> Activate User
                                                                    </a>
                                                                </li>
                                                            </has-permission>
                                                        }
                                                        else if (user.ActiveFlag == 1)
                                                        {
                                                            <has-permission module-id="4" action-id="9">
                                                                <li>
                                                                    <a class="dropdown-item" href="javascript:void(0);" onclick="deactivateUser(@user.UserID)">
                                                                        <i class="mdi mdi-lock-outline me-1"></i> Deactivate User
                                                                    </a>
                                                                </li>
                                                            </has-permission>
                                                        }
                                                        <has-permission module-id="4" action-id="7">
                                                            <li>
                                                                <a class="dropdown-item" href="javascript:void(0);" onclick="extraPermission(@user.UserID, @user.RoleID)">
                                                                    <i class="mdi mdi-shield-account-outline me-1"></i> Extra Permission
                                                                </a>
                                                            </li>
                                                        </has-permission>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>


                                    </tr>

                                    <script>
                                        // Load user photo
                                        loadUserPhotoByFilePath(@Html.Raw(JsonConvert.SerializeObject(user.PhotoPath)), 'userPhoto_@user.UserID');
                                    </script>

                                    count++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">No users found</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                </div>




                <div id="gridViewContainer" class="row" style="display:none;">
                    @foreach (var user in users)
                    {
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
                            <div class="card user-card shadow-lg border-0 position-relative"
                                 style="border-radius:18px; overflow:hidden; background: linear-gradient(145deg, #98a6ad, #013b74); color:white; min-height:300px;">

                                <!-- Action Menu -->
                                <div class="dropdown position-absolute top-0 end-0 p-2">
                                    <i class="mdi mdi-dots-vertical cursor-pointer text-white"
                                       style="font-size:1.2rem;" data-bs-toggle="dropdown"></i>

                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <!-- Edit -->
                                        <has-permission module-id="4" action-id="2">
                                            <li>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="editUser(@user.UserID)">
                                                    <i class="mdi mdi-pencil-outline me-1"></i> Edit
                                                </a>
                                            </li>
                                        </has-permission>

                                        <!-- View -->
                                        <has-permission module-id="4" action-id="4">
                                            <li>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="viewUser(@user.UserID)">
                                                    <i class="mdi mdi-eye-outline me-1"></i> View
                                                </a>
                                            </li>
                                        </has-permission>

                                        <!-- Activate / Deactivate -->
                                        @if (user.ActiveFlag == 0)
                                        {
                                            <has-permission module-id="4" action-id="10">
                                                <li>
                                                    <a class="dropdown-item" href="javascript:void(0);" onclick="activateUser(@user.UserID)">
                                                        <i class="mdi mdi-lock-open-outline me-1"></i> Activate
                                                    </a>
                                                </li>
                                            </has-permission>
                                        }
                                        else if (user.ActiveFlag == 1)
                                        {
                                            <has-permission module-id="4" action-id="9">
                                                <li>
                                                    <a class="dropdown-item" href="javascript:void(0);" onclick="deactivateUser(@user.UserID)">
                                                        <i class="mdi mdi-lock-outline me-1"></i> Deactivate
                                                    </a>
                                                </li>
                                            </has-permission>
                                        }

                                        <!-- Extra Permission -->
                                        <has-permission module-id="4" action-id="7">
                                            <li>
                                                <a class="dropdown-item" href="javascript:void(0);" onclick="extraPermission(@user.UserID, @user.RoleID)">
                                                    <i class="mdi mdi-shield-account-outline me-1"></i> Extra Permission
                                                </a>
                                            </li>
                                        </has-permission>
                                    </ul>
                                </div>

                                <!-- Card Content -->
                                <div class="card-body text-center d-flex flex-column align-items-center justify-content-between">

                                    <!-- Profile Photo With Gradient Background -->
                                    <div class="photo-wrapper position-relative mb-3">
                                        <div class="photo-bg rounded-circle"
                                             style="width:110px; height:110px; background: linear-gradient(135deg,#6a11cb,#2575fc); position:absolute; top:0; left:50%; transform:translateX(-50%); z-index:1;"></div>
                                        <img id="gridPhoto_@user.UserID"
                                             src="/images/default-user.png"
                                             class="profile-img rounded-circle border border-2 border-white shadow-sm"
                                             style="width:110px; height:110px; object-fit:cover; position:relative; z-index:2;">
                                    </div>

                                    <!-- User Name -->
                                    <h6 class="user-name mt-2 mb-1 text-truncate" style="max-width:160px;" title="@user.UserName">@user.UserName</h6>

                                    <!-- Gender & Status -->
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <small class="user-gender">
                                            @if (user.GenderName == "Male")
                                            {
                                                <i class="mdi mdi-gender-male text-info"></i> @user.GenderName
                                            }
                                            else if (user.GenderName == "Female")
                                            {
                                                <i class="mdi mdi-gender-female text-pink"></i> @user.GenderName
                                            }
                                            else
                                            {
                                                <i class="mdi mdi-gender-transgender text-purple"></i> @user.GenderName
                                            }
                                        </small>

                                        <!-- Active / Non-Active Badge -->
                                        @if (user.ActiveFlag == 1)
                                        {
                                            <span class="badge rounded-pill bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge rounded-pill bg-danger">Inactive</span>
                                        }
                                    </div>

                                    <!-- Phone -->
                                    <div class="user-phone mb-2">
                                        <i class="mdi mdi-phone text-light"></i> <span>@user.PhoneNumber</span>
                                    </div>

                                    <!-- Role Badge -->
                                    <span class="badge rounded-pill bg-primary mt-1">@user.RoleName</span>
                                </div>
                            </div>
                        </div>

                        <script>
                            loadUserPhotoByFilePath(
                            @Html.Raw(JsonConvert.SerializeObject(user.PhotoPath)),
                                'gridPhoto_@user.UserID'
                            );
                        </script>
                    }
                </div>












                <!-- Pagination -->
                <div class="row">



                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="text-muted small">
                            Showing page <b>@pageNumber</b> of <b>@Math.Ceiling((double)totalRecords / pageSize)</b>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                @{
                                    int totalPages = (int)Math.Ceiling((double)totalRecords / pageSize);
                                    for (int i = 1; i <= totalPages; i++)
                                    {
                                        <li class="page-item @(i == pageNumber ? "active" : "")">
                                            <a class="page-link" href="javascript:void(0)" onclick="changePage(@i)">@i</a>
                                        </li>
                                    }
                                }
                            </ul>
                        </nav>
                    </div>

                </div>

            </div>



        </div>
    </div>




    

</div>





















<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-4">

            <!-- Header -->
            <div class="modal-header bg-primary text-white rounded-top-4">
                <h5 class="modal-title fw-bold" id="addUserModalLabel">
                    <i class="bi bi-person-plus me-2"></i>Add New User
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body px-4 py-3">
                <input type="hidden" asp-for="UserID" />

                <div class="row g-4">
                    <!-- Left Section (Form Fields) -->
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="UserName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" asp-for="UserName" class="form-control form-control-lg" placeholder="Enter full name" />
                            <span asp-validation-for="UserName" class="text-danger small"></span>
                        </div>
                           <div class="mb-3">
                            <label for="PasswordHash" class="form-label fw-semibold">Password</label>
                            <input type="text" asp-for="PasswordHash" class="form-control form-control-lg" placeholder="Enter Password" />
                            <span asp-validation-for="PasswordHash" class="text-danger small"></span>
                        </div>


                        <div class="mb-3">
                            <label for="MailTypeID" class="form-label fw-semibold">Mail Type</label>
                            @Html.DropDownList("MailTypeID", ViewBag.MailTypeList as List<SelectListItem>, new { @class = "form-select form-select-lg" })
                            <span asp-validation-for="MailTypeID" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label for="Email" class="form-label fw-semibold">Email Address</label>
                            <input type="email" asp-for="Email" class="form-control form-control-lg" placeholder="example@domain.com" />
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label for="PhoneNumber" class="form-label fw-semibold">Phone Number</label>
                            <input type="text" asp-for="PhoneNumber" class="form-control form-control-lg" placeholder="Enter phone number" />
                            <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label for="RoleID" class="form-label fw-semibold">User Role</label>
                            @Html.DropDownList("RoleID", ViewBag.RoleList as List<SelectListItem>, new { @class = "form-select form-select-lg" })
                            <span asp-validation-for="RoleID" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label for="GenderID" class="form-label fw-semibold">Gender</label>
                            @Html.DropDownList("GenderID", ViewBag.GenderList as List<SelectListItem>, new { @class = "form-select form-select-lg" })
                            <span asp-validation-for="GenderID" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Right Section (Image Upload) -->
                    <div class="col-md-4 text-center border-start">
                        <div class="d-flex flex-column align-items-center justify-content-center h-100">
                            <div class="border rounded-circle overflow-hidden mb-3" style="width: 120px; height: 120px;">
                                <img id="profilePreview" src="/images/default-user.png" alt="Profile" class="img-fluid w-100 h-100 object-fit-cover" />
                            </div>

                            <button class="btn btn-outline-primary btn-sm mb-2 px-4" onclick="openFileUpload('UserCreation')">
                                <i class="bi bi-upload me-1"></i>Upload Profile
                            </button>

                            <span id="PhotoPath" class="text-danger small mb-2"></span>

                            <button type="button" class="btn btn-outline-info btn-sm" id="showFile" style="display:none" onclick="openFileViewModalshow()">
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer d-flex justify-content-between px-4">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="window.location.href='/UserCreation/Index'">
                    <i class="bi bi-x-circle me-1" ></i>Cancel
                </button>
                <button type="button" id="btnSaveUser" class="btn btn-success px-4">
                    <i class="bi bi-check-circle me-1"></i>Save User
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="permissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

            <!-- Header -->
            <div class="modal-header text-white"
                 style="background: linear-gradient(135deg, #4facfe, #4facfe);">
                <h5 class="modal-title fw-bol   d d-flex align-items-center">
                    <i class="bi bi-ui-checks-grid me-2"></i> Manage Extra Permissions
                </h5>
                <button type="button"
                        class="btn btn-light rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                        onclick="window.location.href='/UserCreation/Index'"
                        style="width: 38px; height: 38px; border: none;">
                    <i class="bi bi-x-lg text-dark fw-bold"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="modal-body bg-light">

                <!-- Role dropdown -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-dark">Select Role</label>
                        <select id="roleDropdown"
                                class="form-select shadow-sm border rounded-3 px-3 py-2"
                                onchange="onRoleChange()"
                                style="transition: all 0.2s ease;">
                            <option value="">-- Choose Role --</option>
                            @if (ViewBag.Roles != null)
                            {
                                List<RolePermission> roles = ViewBag.Roles as List<RolePermission>;
                                @foreach (var role in roles)
                                {
                                    <option value="@role.RoleID">@role.RoleName</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                <!-- Global Select All -->
                <div class="alert alert-light border rounded-3 shadow-sm d-flex align-items-center justify-content-between px-3 py-2">
                    <span class="fw-bold text-dark">
                        <i class="bi bi-check2-circle text-success"></i> Select All Permissions
                    </span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="selectAllGlobal">
                    </div>
                </div>

                <!-- Permissions container -->
                <div id="permissionsContainer" class="accordion mt-3">
                    <p class="text-muted">Choose a role to load permissions...</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0 bg-light d-flex justify-content-end gap-2">
                <!-- Save Button -->
                <button type="button"
                        class="btn text-white fw-semibold d-flex align-items-center gap-2"
                        style="background: linear-gradient(135deg, #42e695, #3bb2b8); border-radius: 10px; padding: 0.6rem 1.4rem; transition: all 0.3s;"
                        id="SaveExtraPermissions"
                        onclick="saveExtraPermissions()">
                    <i class="bi bi-save-fill"></i> Save
                </button>

                <!-- Close Button -->
                <button type="button"
                        class="btn btn-warning border fw-semibold d-flex align-items-center gap-2"
                        style="border-radius: 10px; padding: 0.6rem 1.4rem; transition: all 0.3s;"
                        onclick="window.location.href='/UserCreation/Index'">
                    <i class="bi bi-x-circle"></i> Close
                </button>
            </div>



        </div>
    </div>
</div>

<script src="~/js/usercreation.js"></script>


@section Scripts {

    <script>


              document.addEventListener("DOMContentLoaded", function() {
            // Get last saved view from localStorage
            const savedView = localStorage.getItem("userView");

            if(savedView === "grid") {
                toggleView("grid");
            } else {
                toggleView("list"); // default
            }
        });

        function toggleView(view) {
            const grid = document.getElementById("gridViewContainer");
            const list = document.getElementById("listViewContainer");
            const btnGrid = document.getElementById("btnGridView");
            const btnList = document.getElementById("btnListView");

            if (view === "grid") {
                grid.style.display = "flex";
                list.style.display = "none";
                btnGrid.style.display = "none";
                btnList.style.display = "inline-block";
            } else {
                grid.style.display = "none";
                list.style.display = "block";
                btnGrid.style.display = "inline-block";
                btnList.style.display = "none";
            }

            // Save user preference
            localStorage.setItem("userView", view);
        }






        (function () {
            // Current server-side values
            const current = {
                pageNumber: parseInt('@pageNumber'),
                pageSize: parseInt('@pageSize'),
                search: '@(search ?? "")',
                searchCol: '@(searchCol ?? "")',
                sortColumn: '@(sortColumn ?? "")',
                sortDir: '@(sortDir ?? "ASC")',
                status: '@(ViewBag.Status ?? "")'
            };

            function buildUrl(params) {
                const qs = new URLSearchParams();
                qs.set('pageNumber', params.pageNumber ?? current.pageNumber);
                qs.set('pageSize', params.pageSize ?? current.pageSize);
                if ((params.search ?? current.search) !== '') qs.set('search', params.search ?? current.search);
                qs.set('searchCol', params.searchCol ?? current.searchCol);
                qs.set('sortColumn', params.sortColumn ?? current.sortColumn);
                qs.set('sortDir', params.sortDir ?? current.sortDir);
                if ((params.status ?? current.status) !== '') qs.set('status', params.status ?? current.status);
                return `/UserCreation/Index?` + qs.toString();
            }

            function navigateTo(params) {
                window.location.href = buildUrl(params);
            }

            // Page change
            window.changePage = function (page) {
                navigateTo({ pageNumber: page });
            };

            // Sorting
            window.sortTable = function (column) {
                let newDir = current.sortDir === 'ASC' ? 'DESC' : 'ASC';
                if (current.sortColumn !== column) newDir = 'ASC';
                navigateTo({ pageNumber: 1, sortColumn: column, sortDir: newDir });
            };

            // Search button
            $('#btnSearch').click(function () {
                const search = $('#search').val();
                const searchCol = $('#searchCol').val();
                const status = $('#activeStatus').val();
                navigateTo({ pageNumber: 1, search: search, searchCol: searchCol, status: status });
            });

            // Page Size change
            $('#pageSize').on('change', function () {
                navigateTo({ pageNumber: 1, pageSize: parseInt($(this).val(), 10) });
            });
        })();

        // Edit/Delete functions

    </script>

}

