@model CoreOne.DOMAIN.Models.MenuWithModulesSave

@using CoreOne.DOMAIN.Models
@{
    ViewData["Title"] = "Menu Module Master";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int pageNumber = ViewBag.PageNumber ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int totalRecords = ViewBag.TotalRecords ?? 0;
    int totalPages = (int)Math.Ceiling(totalRecords / (double)pageSize);

    string search = ViewBag.Search ?? "";
    string sortColumn = ViewBag.SortColumn ?? "MenuName";
    string sortDir = ViewBag.SortDir ?? "ASC";
    string searchCol = ViewBag.SearchCol ?? "MenuName";

    var modules = ViewBag.MenuModules as List<MenuModuleDto> ?? new List<MenuModuleDto>();

    int maxWindow = 5;
    int startPage = 1;
    int endPage = totalPages;
    if (totalPages > maxWindow)
    {
        int half = maxWindow / 2;
        startPage = pageNumber - half;
        endPage = pageNumber + half;
        if (startPage < 1) { startPage = 1; endPage = maxWindow; }
        else if (endPage > totalPages) { endPage = totalPages; startPage = totalPages - maxWindow + 1; }
    }
    else { startPage = 1; endPage = totalPages; }
}
<style>
    /* Table base */
    .table {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

        /* Table header */
        .table thead tr {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
         
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Table body rows */
        .table tbody tr {
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

    /* Table cells */
    .table th,
    .table td {
        border: 1px solid #d1d5db; /* light gray borders */
        vertical-align: middle;
        padding: 0.75rem 1rem;
    }

   

 
</style>



<div class="container-fluid">

    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Menu & Module</a></li>
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Dashboard</a></li>
                        <li class="breadcrumb-item active">SetUp</li>
                    </ol>
                </div>
                <h4 class="page-title">Module SetUp</h4>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="row justify-content-between">
                <div class="col-auto">
                    <button type="button" class="btn btn-blue waves-effect waves-light float-end rounded-pill" style="background: linear-gradient(135deg, #8173fa, #5a48e5);"
                            onclick="window.location.href='/ModuleSetup/Index'">
                        <i class="mdi mdi-refresh-circle"></i> Refresh
                    </button>
                </div>
                <div class="col-auto">

                    <button type="button" class="btn btn-success float-end rounded-pill" data-bs-toggle="modal" data-bs-target="#moduleSetupModal" style="background: linear-gradient(135deg, #13dc72, #004993);">
                            <i class="mdi mdi-plus-circle"></i> Create Module SetUp
                        </button>
               
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">

            <div class="row mb-3 align-items-center">
                <div class="col-md-3">
                    <input type="search" id="searchBox" value="@search" class="form-control rounded-pill" placeholder="Search..." />
                </div>
                <div class="col-md-2">
                    <select class="form-select rounded-pill" id="searchField">
                        @{
                            string[] searchableFields = { "MenuName", "ModuleName" };
                            string[] searchableNames = { "Menu", "Modules" };
                            for (int i = 0; i < searchableFields.Length; i++)
                            {
                                var field = searchableFields[i];
                                <option value="@field" selected="@(field == searchCol)">@searchableNames[i]</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="btnSearch" class="btn rounded-pill" style="background:linear-gradient(135deg, #4ad7f8, #0487a5);color:white; border: 1px solid #4fc6e1;">
                        <i class="mdi mdi-magnify"></i> Search
                    </button>
                </div>
                <div class="col-md-2 ms-auto d-flex justify-content-end">
                    <select class="form-select rounded-pill" id="pageSize">
                        @{
                            int[] pageSizes = { 1, 10, 20, 50, 100 };
                            foreach (var size in pageSizes)
                            {
                                <option value="@size" selected="@(size == pageSize)">@size</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <style>
                .module-badge {
                    display: inline-block;
                    padding: 0.35em 0.75em;
                    font-weight: 600;
                    color: #fff;
                    border: 2px solid #424e5a;
                    background: linear-gradient(135deg, #005fbe, #1682ff);
                    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                    transition: transform 0.2s, box-shadow 0.2s;
                }

                    .module-badge:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    }

            </style>

            <table class="table table-bordered  table-hover">
                <thead>
                    <tr style="background: #f3f7f9;color:black">
                        <th style="color:black">Sl No</th>
                        <th style ="color:black">
                            <a href="javascript:void(0)" style="color:black"  onclick="sortTable('MenuName')" class="d-flex justify-content-between">
                                Menu
                                @(sortColumn == "MenuName" ? (sortDir == "ASC" ? "↑" : "↓") : "↕")
                            </a>
                        </th>
                        <th >Modules</th>
                        <th style="color:black">
                            <a href="javascript:void(0)" style="color:black" onclick="sortTable('CreatedDate')" class="d-flex justify-content-between">
                                Created Date
                                @(sortColumn == "CreatedDate" ? (sortDir == "ASC" ? "↑" : "↓") : "↕")
                            </a>
                        </th>
                        <th style="color:black">Action</th>
                    </tr>
                </thead>

            
                <tbody>
                    @{
                        int count = ((pageNumber - 1) * pageSize) + 1;
                        foreach (var m in modules)
                        {
                            <tr>
                                <td>@count</td>
                                <td class="text-body fw-semibold">@m.MenuName</td>
                                <td>
                                    @{
                                        if (!string.IsNullOrEmpty(m.Modules))
                                        {
                                            var modulesList = m.Modules.Split(',');
                                            foreach (var moduleName in modulesList)
                                            {
                                                <span class="badge module-badge  me-1">@moduleName.Trim()</span>
                                            }
                                        }
                                    }
                                </td>

                                <td>@(m.CreatedDate?.ToString("dd-MM-yyyy"))</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="openEditModal(@m.MenuModuleID)">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteMenu(@m.MenuModuleID)">Delete</button>
                                </td>
                            </tr>
                            count++;
                        }
                        if (!modules.Any())
                        {
                            <tr><td colspan="5" class="text-center text-muted">No records found</td></tr>
                        }
                    }
                </tbody>
            </table>

            <!-- Pagination -->
            <nav>
                <ul class="pagination">
                    <li class="page-item @(pageNumber==1?"disabled":"")">
                        <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber - 1)">Prev</a>
                    </li>

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i==pageNumber?"active":"")">
                            <a class="page-link" href="javascript:void(0)" data-page="@i">@i</a>
                        </li>
                    }

                    <li class="page-item @(pageNumber>=totalPages?"disabled":"")">
                        <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber + 1)">Next</a>
                    </li>
                </ul>
            </nav>

        </div>
    </div>

</div>



<div class="modal fade" id="moduleSetupModal" tabindex="-1" aria-labelledby="moduleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-sm rounded-3">
            <div class="modal-header bg-primary text-white border-0 rounded-top py-2">
                <h5 class="modal-title" id="moduleModalLabel">Create Menu & Modules</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="menuModuleForm">
                <div class="modal-body p-3 bg-light">
                    <input asp-for="MenuModuleID" type="hidden" id="hdnMenuModuleID" />

                    <!-- Accordion -->
                    <div class="accordion" id="menuModuleAccordion">

                        <!-- MENU SECTION -->
                        
                            <div class="accordion-item mb-2">
                            <h2 class="accordion-header" id="menuHeading">
                                <button class="accordion-button fw-bold py-2" style="border-radius: 6px;"
                                        type="button" data-bs-toggle="collapse"
                                        data-bs-target="#menuCollapse"
                                        aria-expanded="true"
                                        aria-controls="menuCollapse">
                                    Menu Details
                                </button>
                            </h2>



                            <div id="menuCollapse" class="accordion-collapse collapse show" aria-labelledby="menuHeading">
                                <div class="accordion-body p-3 bg-white rounded-3 shadow-sm border">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold small">Menu Name</label>
                                            <input type="text" id="MenuName" class="form-control form-control-sm" placeholder="Enter Menu Name" />
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold small">Sequence</label>
                                            <input type="number" id="MenuSeq" class="form-control form-control-sm" placeholder="Seq" />
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label fw-semibold small">Menu Icon</label>
                                            <input type="text" id="MenuSymbol" class="form-control form-control-sm mb-1" placeholder="Select Icon" readonly />
                                            <div class="icon-scroll-container">
                                                <div class="icons-list-demo d-flex flex-nowrap" id="iconList">
                                                    <div class="icon-item mx-1" title="Home"><i class="fe-home" style="margin-left:11px"></i></div>
                                                    <div class="icon-item mx-1" title="Settings"><i class="fe-settings" style="margin-left:11px"></i></div>
                                                    <div class="icon-item mx-1" title="User"><i class="fe-user" style="margin-left:11px"></i></div>
                                                    <div class="icon-item mx-1" title="Bell"><i class="fe-bell" style="margin-left:11px"></i></div>
                                                    <div class="icon-item mx-1" title="Star"><i class="fe-star" style="margin-left:11px"></i></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- MODULE SECTION -->
                        <div class="accordion-item mb-2">
                            <h2 class="accordion-header" id="moduleHeading">
                                <button class="accordion-button collapsed fw-bold py-2" style="border-radius: 6px;" type="button" data-bs-toggle="collapse" data-bs-target="#moduleCollapse" aria-expanded="false" aria-controls="moduleCollapse">
                                    Module Details
                                </button>
                            </h2>
                            <div id="moduleCollapse" class="accordion-collapse collapse" aria-labelledby="moduleHeading">
                                <div class="accordion-body p-3 bg-white rounded-3 shadow-sm border">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold small">Module Name</label>
                                            <input type="text" id="ModuleName" class="form-control form-control-sm" placeholder="Enter Module Name" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold small">Module URL</label>
                                            <input type="text" id="ModuleUrl" class="form-control form-control-sm" placeholder="Enter Module URL" />
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label fw-semibold small">Seq</label>
                                            <input type="number" id="ModuleSeq" class="form-control form-control-sm" placeholder="Seq" />
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-primary w-100 btn-sm" id="addModuleBtn">Add</button>
                                        </div>
                                    </div>

                                    <div class="table-responsive mt-2">
                                        <table class="table table-hover table-bordered align-middle mb-0 table-sm" id="moduleTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="display:none">ModuleId</th>
                                                    <th>Seq</th>
                                                    <th>Name</th>
                                                    <th>URL</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

                <div class="modal-footer border-0 pt-1">
                    <button type="button" onclick="window.location.href='/ModuleSetup/Index'" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="btnSavemenu" class="btn btn-success btn-sm">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Accordion items spacing */
    .accordion-item {
        border: none;
        margin-bottom: 0.5rem; /* space between accordion items */
    }

    /* Accordion headers: fully rounded, gradient, shadows */
    .accordion-button {
        font-size: 0.95rem;
        border-radius: 10px; /* fully rounded */
        background: linear-gradient(145deg, #c3dbff, #dde9f9);
        color: #0d6efd;
        font-weight: 600;

        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        box-shadow: 2px 2px 6px rgba(0,0,0,0.06), -2px -2px 6px rgba(255,255,255,0.7);
        border: none;
    }

        /* Hover effect: light gradient + subtle lift */
        .accordion-button:hover {
            background: background: linear-gradient(145deg, #c3dbff, #dde9f9);
            transform: translateY(-1px);
            box-shadow: 3px 3px 8px rgba(0,0,0,0.08), -3px -3px 8px rgba(255,255,255,0.7);
        }

        /* Expanded header: blue gradient + white text */
        .accordion-button:not(.collapsed) {
            background: linear-gradient(145deg, #1d68d5, #00af6e);
            color: #fff;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.15);
        }

    /* Accordion body: rounded bottom corners, shadow */
    .accordion-body {
        background-color: #fff;
        border-radius: 0 0 10px 10px; /* only bottom corners rounded */
        padding: 0.75rem !important;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.03);
        border-top: none;
    }

    /* Inputs: compact and modern */
    .form-control.form-control-sm {
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    /* Icon scroll container */
    .icon-scroll-container {
        overflow-x: auto;
        white-space: nowrap;
        padding: 6px;
        border-radius: 8px;
        background-color: #f5f7fa;
        box-shadow: inset 0 0 3px rgba(0,0,0,0.05);
        margin-top: 4px;
    }

    /* Icon items: circle, hover scale, shadow */
    .icon-item {
        flex: 0 0 auto;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        border-radius: 50%;
        background-color: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        line-height: 1;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        margin-right: 4px;
    }

        .icon-item:hover {
            background-color: #e6f0ff;
            transform: scale(1.15);
            box-shadow: 0 3px 6px rgba(0,0,0,0.12);
        }

        .icon-item.selected {
            border: 2px solid #0d6efd;
            background-color: #d0e4ff;
            transform: scale(1.15);
        }

    /* Tables: compact */
    .table-sm th, .table-sm td {
        padding: 0.3rem 0.5rem;
        font-size: 0.85rem;
    }
</style>





@section Scripts {
    





 



    <script>





        // Open edit modal
        function openEditModal(menuId) {
            fetch(`/ModuleSetup/GetMenuForEdit?id=${menuId}`)
                .then(res => res.ok ? res.json() : Promise.reject("Failed to load menu"))
                .then(data => {
                    if (!data) throw new Error("No data returned");

                    // Populate menu fields
                    $("#hdnMenuModuleID").val(data.menuID);
                    $("#MenuName").val(data.menuName);
                    $("#MenuSeq").val(data.menuSeq);
                    $("#MenuSymbol").val(data.menuSymbol);

                    const tbody = $("#moduleTable tbody").empty();

                    if (data.modules && data.modules.length > 0) {
                        // Sort modules by sequence ascending
                        const sortedModules = data.modules.sort((a, b) => a.sequence - b.sequence);

                        sortedModules.forEach(m => {
                            // Check for duplicate sequence in table
                            const seqExists = $("#moduleTable tbody tr").filter(function () {
                                return parseInt($(this).find(".moduleSeq input").val()) === m.sequence;
                            }).length > 0;

                            if (!seqExists) {
                                tbody.append(`
                                    <tr data-module-id="${m.moduleID}">
                                        <td class="moduleId" style="display:none">${m.moduleID}</td>
                                        <td class="moduleSeq">
                                            <input type="number" class="form-control form-control-sm" value="${m.sequence}" />
                                        </td>
                                        <td class="moduleName">
                                            <input type="text" class="form-control form-control-sm" value="${m.name}" />
                                        </td>
                                        <td class="moduleUrl">
                                            <input type="text" class="form-control form-control-sm" value="${m.url}" />
                                        </td>
                                         <td class="d-flex gap-1 justify-content-start">
       
            <a href="javascript:void(0);" class="btn btn-sm btn-primary setupModule" title="Setup"><i class="fe-settings"></i></a>
        </td>
                                    </tr>
                                `);
                            }
                        });
                    }

                    $("#moduleSetupModal").modal("show");
                })
                .catch(err => alert(err));
        }

        // Add module to table
        $("#addModuleBtn").click(function () {
            const name = $("#ModuleName").val().trim();
            const url = $("#ModuleUrl").val().trim();
            const seq = $("#ModuleSeq").val().trim();

            // Validate empty fields
            if (!name || !url || !seq) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Please enter Module Name, URL, and Sequence.'
                });
                return;
            }

            // Check for duplicate sequence
            const seqExists = $("#moduleTable tbody tr").filter(function () {
                return parseInt($(this).find(".moduleSeq input").val()) === parseInt(seq);
            }).length > 0;

            if (seqExists) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Sequence number already exists. Please use a unique sequence.'
                });
                return;
            }

            // Create new row with input fields
            const row = `
                <tr data-module-id="">
                    <td class="moduleId" style="display:none"></td>
                    <td class="moduleSeq"><input type="number" class="form-control form-control-sm" value="${seq}" /></td>
                    <td class="moduleName"><input type="text" class="form-control form-control-sm" value="${name}" /></td>
                    <td class="moduleUrl"><input type="text" class="form-control form-control-sm" value="${url}" /></td>
              <td class="d-flex gap-1 justify-content-start">
            <a href="javascript:void(0);" class="btn btn-sm btn-danger removeModule" title="Remove">
                <i class="fe-trash"></i>
            </a>
            <a href="javascript:void(0);" class="btn btn-sm btn-primary setupModule" title="Setup">
                <i class="fe-settings"></i>
            </a>
        </td>
                </tr>`;

            // Insert row in ascending sequence order
            let inserted = false;
            $("#moduleTable tbody tr").each(function () {
                const currentSeq = parseInt($(this).find(".moduleSeq input").val());
                if (parseInt(seq) < currentSeq) {
                    $(this).before(row);
                    inserted = true;
                    return false;
                }
            });

            if (!inserted) {
                $("#moduleTable tbody").append(row);
            }

            // Clear input fields
            $("#ModuleName, #ModuleUrl, #ModuleSeq").val('');
        });

        // Remove module button
        $(document).on("click", ".removeModule", function () {
            $(this).closest("tr").remove();
        });





                 // Map input IDs to model property names
        const fieldMap = {
            "MenuName": "Name",
            "MenuSeq": "Sequence",
            "MenuSymbol": "MenuSymbol"
        };


                // When user clicks an icon
        $("#iconList .icon-item").click(function () {
            // Get the icon name or identifier (for example, use class)
            const iconClass = $(this).find("i").attr("class"); // e.g., "fe-home"

            // Set the input value
            $("#MenuSymbol").val(iconClass);

            // Trigger validation for MenuSymbol
            const menuId = $("#hdnMenuModuleID").val() || null;
            validateMenuField("MenuSymbol", menuId);
        });

        // Validate Menu fields with server AND client empty check
        function validateMenuField(fieldId, menuId = null) {
            let $input = $("#" + fieldId);
            let $errorSpan = $("#" + fieldId + "-error");
            let value = $input.val().trim();

            // Clear previous state
            $input.removeClass("is-invalid is-valid");
            $errorSpan.text('');

            // Client-side empty check
            if (!value) {
                $input.addClass("is-invalid");
                $errorSpan.text("This field is required.");
                return $.Deferred().resolve().promise(); // Stop AJAX, already invalid
            }

            // Server-side validation
            let payload = {};
            payload[fieldId] = value;
            if (menuId) payload["MenuModuleID"] = menuId;

            return $.ajax({
                url: '/ModuleSetup/ValidateMenuField',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (resp) {
                    const modelField = fieldMap[fieldId];
                    if (resp.errors && resp.errors[modelField]) {
                        $input.addClass("is-invalid");
                        $errorSpan.text(resp.errors[modelField][0]);
                    } else {
                        $input.addClass("is-valid");
                    }
                }
            });
        }

        // Real-time validation
        $("#MenuName, #MenuSeq, #MenuSymbol").on("input change", function () {
            const menuId = $("#hdnMenuModuleID").val() || null;
            validateMenuField(this.id, menuId);
        });

               // Save Menu + Modules
        $("#btnSavemenu").click(async function () {
            const menuId = $("#hdnMenuModuleID").val();

            // Validate menu fields first
                  // Validate menu fields first
        await validateMenuField("MenuName", menuId);
        await validateMenuField("MenuSeq", menuId);
        await validateMenuField("MenuSymbol", menuId);

        // Prevent save if validation fails
        if ($("#MenuName").hasClass("is-invalid") ||
            $("#MenuSeq").hasClass("is-invalid") ||
            $("#MenuSymbol").hasClass("is-invalid")) {

            
            return; // stop execution
        }

        // Check if at least one module exists
        const moduleCount = $("#moduleTable tbody tr").length;
        if (moduleCount === 0) {
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Please add at least one module before saving.'
            });
            return; // stop execution
        }

        // Continue to build payload and save...


            // Build payload
            const menuWithModules = {
                MenuModuleID: menuId ? parseInt(menuId) : null,
                Name: $("#MenuName").val().trim(),
                MenuSymbol: $("#MenuSymbol").val().trim(),
                Sequence: parseInt($("#MenuSeq").val()),
                RecType: menuId ? 'U' : 'I',
                Modules: []
            };

                  // Collect modules (read from input fields)
        $("#moduleTable tbody tr").each(function () {
            const row = $(this);
            const moduleId = row.data("module-id");

            menuWithModules.Modules.push({
                ModuleID: moduleId ? parseInt(moduleId) : null,
                Name: row.find(".moduleName input").val().trim(),
                Url: row.find(".moduleUrl input").val().trim(),
                Sequence: parseInt(row.find(".moduleSeq input").val())
            });
        });


            // Send save request
            try {
                const resp = await fetch("/ModuleSetup/SaveMenuWithModules", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(menuWithModules)
                });

                if (!resp.ok) {
                    const errText = await resp.text();
                    throw new Error(errText);
                }

                const result = await resp.json();
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Menu & Modules saved successfully.',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    $("#moduleSetupModal").modal("hide");
                    location.reload();
                });

            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Error saving menu/modules: ' + err.message
                });
            }
        });









    </script>
    <script>


        (function(){
            const searchInput = document.getElementById('searchBox');
            const searchField = document.getElementById('searchField');
            const pageSizeSelect = document.getElementById('pageSize');
            const btnSearch = document.getElementById('btnSearch');

            const current = {
                pageNumber: @pageNumber,
                pageSize: @pageSize,
                search: "@search",
                searchCol: "@searchCol",
                sortColumn: "@sortColumn",
                sortDir: "@sortDir"
            };

            function buildUrl(params){
                const qs = new URLSearchParams();
                qs.set('pageNumber', params.pageNumber ?? 1);
                qs.set('pageSize', params.pageSize ?? current.pageSize);
                if((params.search ?? current.search) !== '') qs.set('search', params.search ?? current.search);
                qs.set('searchCol', params.searchCol ?? current.searchCol);
                qs.set('sortColumn', params.sortColumn ?? current.sortColumn);
                qs.set('sortDir', params.sortDir ?? current.sortDir);
                return '@Url.Action("Index", "ModuleSetup")' + '?' + qs.toString();
            }

            function navigateTo(opts){ window.location.href = buildUrl(opts); }

            // Search button click
            btnSearch?.addEventListener('click', () => {
                navigateTo({
                    pageNumber: 1,
                    search: searchInput.value,
                    searchCol: searchField.value,
                    pageSize: parseInt(pageSizeSelect.value, 10),
                    sortColumn: current.sortColumn,
                    sortDir: current.sortDir
                });
            });

            // Page size change
            pageSizeSelect?.addEventListener('change', () => {
                navigateTo({
                    pageNumber: 1,
                    search: searchInput.value,
                    searchCol: searchField.value,
                    pageSize: parseInt(pageSizeSelect.value, 10),
                    sortColumn: current.sortColumn,
                    sortDir: current.sortDir
                });
            });

            // Pagination links
            document.querySelectorAll('.pagination a.page-link').forEach(el => {
                el.addEventListener('click', ev => {
                    ev.preventDefault();
                    const page = parseInt(el.dataset.page,10) || 1;
                    navigateTo({
                        pageNumber: page,
                        search: searchInput.value,
                        searchCol: searchField.value,
                        pageSize: parseInt(pageSizeSelect.value, 10),
                        sortColumn: current.sortColumn,
                        sortDir: current.sortDir
                    });
                });
            });

            // Sorting
            window.sortTable = function(column){
                let newDir = current.sortColumn === column && current.sortDir === 'ASC' ? 'DESC' : 'ASC';
                navigateTo({
                    pageNumber: 1,
                    search: searchInput.value,
                    searchCol: searchField.value,
                    pageSize: parseInt(pageSizeSelect.value, 10),
                    sortColumn: column,
                    sortDir: newDir
                });
            };
        })();
        document.addEventListener("DOMContentLoaded", function () {
            const icons = document.querySelectorAll(".icon-item");
            const input = document.getElementById("MenuSymbol");

            icons.forEach(icon => {
                icon.addEventListener("click", function () {
                    // remove previous selection
                    icons.forEach(i => i.classList.remove("selected"));
                    this.classList.add("selected");

                    // extract class name
                    const iconClass = this.querySelector("i").className.trim();
                    input.value = iconClass;
                });
            });
        });
    </script>

}
