@model CoreOne.DOMAIN.Models.RoleCreation
@using CoreOne.DOMAIN.Models
@{
    ViewData["Title"] = "Role Master";
    
    int pageNumber = ViewBag.PageNumber ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int totalRecords = ViewBag.TotalRecords ?? 0;
    int totalPages = (int)Math.Ceiling(totalRecords / (double)pageSize);

    string search = ViewBag.Search ?? "";
    string sortColumn = ViewBag.SortColumn ?? "RoleName";
    string sortDir = ViewBag.SortDir ?? "ASC";
    string searchCol = ViewBag.SearchCol ?? "RoleName";

    var roles = ViewBag.Roles as List<RoleCreation> ?? new List<RoleCreation>();

    // Pagination window server-side: show up to 5 pages
    int maxWindow = 5;
    int startPage = 1;
    int endPage = totalPages;

    if (totalPages > maxWindow)
    {
        int half = maxWindow / 2; // 2
        startPage = pageNumber - half;
        endPage = pageNumber + half;

        if (startPage < 1)
        {
            startPage = 1;
            endPage = maxWindow;
        }
        else if (endPage > totalPages)
        {
            endPage = totalPages;
            startPage = totalPages - maxWindow + 1;
        }
    }
    else
    {
        startPage = 1;
        endPage = totalPages;
    }
}

<link href="~/css/rolecreation.css" rel="stylesheet" />





<div class="container-fluid  p-2" style="background:rgba(255, 255, 255, 0.08);">
    <div class="row" style="margin-top: -19px; margin-bottom: -6px;">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Master</a></li>
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Dashboard</a></li>

                    </ol>
                </div>
                <h4 class="page-title">Role Creation</h4>
            </div>
        </div>
    </div>


    <div class="card" style="background:rgba(255, 255, 255, 0.08);border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
        <div class="card-body">

            <div class="row align-items-center p-2 mb-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
                <div class="col-md-3">
                    <button type="button" class="btn btn-blue waves-effect waves-light" style="background: linear-gradient(135deg, #8173fa, #5a48e5);border-radius: 11px;"
                            onclick="window.location.href='/RoleCreation/Index'">
                        <i class="mdi mdi-refresh-circle"></i> Refresh
                    </button>

                </div>
                <div class="col-md-5">
                </div>

                <div class="col-md-4 ms-auto d-flex justify-content-end">
                    

                    <has-permission module-id="5" action-id="1">


                        <button type="button" class="btn btn-success float-end" data-bs-toggle="modal" data-bs-target="#roleModal" style="background: linear-gradient(135deg, #13dc72, #004993);    border-radius: 11px;">
                            <i class="mdi mdi-plus-circle"></i> Add Role
                        </button>
                    </has-permission>
                </div>
            </div>

            <div class="row align-items-center p-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
                
            <div class="col-md-3">
                    <input type="search" id="searchBox" value="@search" class="form-control" placeholder="Search..." style="border-radius: 11px;  background: linear-gradient(135deg, #f8fbff, #ffffff);" />
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="searchField" style="  background: linear-gradient(135deg, #f8fbff, #ffffff);   border-radius: 11px;">
                        @{
                            string[] searchableFields = new string[] { "RoleName", "RoleDescription", "ActiveFlag" };
                            string[] searchableNames = new string[] { "Role Name", "Role Description", "Status" };
                            for (int i = 0; i < searchableFields.Length; i++)
                            {
                                var field = searchableFields[i];
                                <option value="@field" selected="@(field == searchCol)">@searchableNames[i]</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="btnSearch" class="btn icon-btn" style="display:none">
                        <i class="mdi mdi-magnify"></i>
                    </button>

                </div>
                <div class="col-md-2 ms-auto d-flex justify-content-end">
                    <select class="form-select" id="pageSize" style="border-radius: 11px; background: linear-gradient(135deg, #f8fbff, #ffffff);">
                        @{
                            int[] pageSizes = new int[] { 1, 10, 20, 50, 100 };
                            foreach (var size in pageSizes)
                            {
                                <option value="@size" selected="@(size == pageSize)">@size</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="row align-items-center p-2 mt-2 mb-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #b1d8ff; backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
                <table class="table table-bordered table-hover table-xl mt-2">
                    <thead>
                        <tr style="background: #f3f7f9;color:black">
                            <th style="color:black">Sl No</th>

                            <th>
                                <a href="javascript:void(0)" onclick="sortTable('RoleName')" class="d-flex justify-content-between align-items-center text-decoration-none" style="color:black">
                                    <span>Role Name</span>
                                    <span>
                                        @if (sortColumn == "RoleName")
                                        {
                                            if (sortDir == "ASC")
                                            {
                                                <i class="bi bi-arrow-up"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down"></i>
                                            }
                                        }
                                        else
                                        {
                                            <i class="bi bi-arrow-down-up text-muted"></i>
                                        }
                                    </span>
                                </a>
                            </th>

                            <th>
                                <a href="javascript:void(0)" onclick="sortTable('RoleDescription')" class="d-flex justify-content-between align-items-center text-decoration-none" style="color:black">
                                    <span>Role Description</span>
                                    <span>
                                        @if (sortColumn == "RoleDescription")
                                        {
                                            if (sortDir == "ASC")
                                            {
                                                <i class="bi bi-arrow-up"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down"></i>
                                            }
                                        }
                                        else
                                        {
                                            <i class="bi bi-arrow-down-up text-muted"></i>
                                        }
                                    </span>
                                </a>
                            </th>

                            <th>
                                <a href="javascript:void(0)" onclick="sortTable('CreatedDate')" class="d-flex justify-content-between align-items-center text-decoration-none" style="color:black">
                                    <span>Created Date</span>
                                    <span>
                                        @if (sortColumn == "CreatedDate")
                                        {
                                            if (sortDir == "ASC")
                                            {
                                                <i class="bi bi-arrow-up"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down"></i>
                                            }
                                        }
                                        else
                                        {
                                            <i class="bi bi-arrow-down-up text-muted"></i>
                                        }
                                    </span>
                                </a>
                            </th>

                            <th>
                                <a href="javascript:void(0)" onclick="sortTable('ActiveFlag')" class="d-flex justify-content-between align-items-center text-decoration-none" style="color:black">
                                    <span>Status</span>
                                    <span>
                                        @if (sortColumn == "ActiveFlag")
                                        {
                                            if (sortDir == "ASC")
                                            {
                                                <i class="bi bi-arrow-up"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-arrow-down"></i>
                                            }
                                        }
                                        else
                                        {
                                            <i class="bi bi-arrow-down-up text-muted"></i>
                                        }
                                    </span>
                                </a>
                            </th>

                            <th style="color:#343a40">Action</th>
                        </tr>
                    </thead>


                    <tbody>
                        @{
                            int count = ((pageNumber - 1) * pageSize) + 1;
                        }
                        @foreach (var r in roles)
                        {
                            <tr>
                                <td>@count</td>
                                <td class="text-body fw-semibold">@r.RoleName</td>
                                <td>@r.RoleDescription</td>
                                <td>@(r.CreatedDate?.ToString("dd-MM-yyyy"))</td>
                                <td>
                                    @if ((r.ActiveFlag ?? 0) == 1)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Inactive</span>
                                    }
                                </td>


                                <td>
                                    <has-permission module-id="5" action-id="2">

                                        <!-- Edit -->       
                                        <a href="javascript:;" class="action-icon" onclick="loadRole(@r.RoleID)">
                                            <i class="mdi mdi-square-edit-outline" data-toggle="tooltip" title="Edit" style="color:rebeccapurple"></i>
                                        </a>
                                    </has-permission>
                                    <has-permission module-id="5" action-id="4">
                                        <a href="javascript:;"
                                           class="action-icon"
                                           onclick="loadRole(@r.RoleID); $('#btnSaveRole').remove();;">
                                            <i class="mdi mdi-eye-circle-outline" data-toggle="tooltip" title="View" style="color:#fd683b"></i>
                                        </a>


                                    </has-permission>

                                    <has-permission module-id="5" action-id="3">
                                        <!-- Delete form -->

                                        
                                        <a href="javascript:;"
                                           class="action-icon"
                                           onclick="deleteRole(@r.RoleID)">
                                            <i class="mdi mdi-delete" data-toggle="tooltip" title="Delete" style="color:red"></i>
                                        </a>


                                    </has-permission>

                                </td>
                            </tr>
                            count++;
                        }
                        @if (!roles.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted">No records found</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="row">
                  
                        <!-- Bottom info -->
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <small class="text-muted">
                                    Showing page <strong>@pageNumber</strong> of <strong>@totalPages</strong> — <strong>@totalRecords</strong> records
                                </small>
                            </div>

                            <!-- Pagination window (max 5 pages) -->
                            <nav aria-label="Role pagination">
                                <ul class="pagination pagination-rounded mb-0">
                                    <!-- Prev -->
                                    <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
                                        <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber - 1)">« Prev</a>
                                    </li>

                                    <!-- If startPage > 1 show first page and ellipsis -->
                                    @if (startPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="javascript:void(0)" data-page="1">1</a>
                                        </li>
                                        @if (startPage > 2)
                                        {
                                            <li class="page-item disabled"><span class="page-link">…</span></li>
                                        }
                                    }

                                    <!-- Window pages -->
                                    @for (int i = startPage; i <= endPage; i++)
                                    {
                                        <li class="page-item @(i == pageNumber ? "active" : "")">
                                            <a class="page-link" href="javascript:void(0)" data-page="@i">@i</a>
                                        </li>
                                    }

                                    <!-- If endPage < totalPages show ellipsis and last page -->
                                    @if (endPage < totalPages)
                                    {
                                        if (endPage < totalPages - 1)
                                        {
                                            <li class="page-item disabled"><span class="page-link">…</span></li>
                                        }
                                        <li class="page-item">
                                            <a class="page-link" href="javascript:void(0)" data-page="@totalPages">@totalPages</a>
                                        </li>
                                    }

                                    <!-- Next -->
                                    <li class="page-item @(pageNumber >= totalPages ? "disabled" : "")">
                                        <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber + 1)">Next »</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    
                </div>

            </div>



        </div>
    </div>













</div>
    <div class="modal fade" id="roleModal" tabindex="-1" aria-labelledby="roleModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roleModalLabel">Add Role :: [New]</h5>
                <button type="button"
                        class="btn btn-light btn-close-circle shadow-sm"
                        onclick="window.location.href='/RoleCreation/Index'">
                    <i class="bi bi-x-lg"></i>
                </button>
                </div>

                <div class="modal-body">
                    @* Hidden field for RoleID *@
                    <input type="hidden" asp-for="RoleID" id="RoleID" />

                    <div class="mb-3">
                        <label asp-for="RoleName" class="form-label"></label>
                        <input asp-for="RoleName" class="form-control" id="RoleName" />
                        <span asp-validation-for="RoleName"  class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="RoleDescription" class="form-label"></label>
                        <textarea asp-for="RoleDescription" class="form-control" id="RoleDescription"></textarea>
                        <span asp-validation-for="RoleDescription" class="text-danger"></span>
                       
                    </div>
                </div>

               
            <div class="modal-footer border-0 pt-1 d-flex justify-content-between">
                <button type="button"
                        onclick="window.location.href='/RoleCreation/Index'"
                        class="btn btn-warning btn-sm"
                        data-bs-dismiss="modal">
                    <i class="mdi mdi-close-circle-outline me-1"></i> Cancel
                </button>

                <button type="button" id="btnSaveRole" class="btn btn-sm" style="background:forestgreen; color:white">
                    <i class="mdi mdi-content-save-outline me-1"></i> Save
                </button>
            </div>

            </div>
        </div>
    </div>


  








@section Scripts {
  

    <script>
        (function () {
            // Utility to build Index URL with query params
            function buildUrl(params) {
                const base = '@Url.Action("Index", "RoleCreation")';
                const qs = new URLSearchParams();
                qs.set('pageNumber', params.pageNumber ?? 1);
                qs.set('pageSize', params.pageSize ?? current.pageSize);
                if ((params.search ?? current.search) !== '') qs.set('search', params.search ?? current.search);
                qs.set('searchCol', params.searchCol ?? current.searchCol);
                qs.set('sortColumn', params.sortColumn ?? current.sortColumn);
                qs.set('sortDir', params.sortDir ?? current.sortDir);
                return base + '?' + qs.toString();
            }

            // Current server-side values
            const current = {
                pageNumber: parseInt('@pageNumber'),
                pageSize: parseInt('@pageSize'),
                search: '@(search ?? "")',
                searchCol: '@(searchCol ?? "")',
                sortColumn: '@(sortColumn ?? "")',
                sortDir: '@(sortDir ?? "")'
            };

            // Debounce
            function debounce(fn, delay) {
                let t;
                return function (...args) {
                    clearTimeout(t);
                    t = setTimeout(() => fn.apply(this, args), delay);
                };
            }

            function navigateTo(opts) {
                const params = {
                    pageNumber: opts.pageNumber ?? 1,
                    pageSize: opts.pageSize ?? current.pageSize,
                    search: opts.search ?? current.search,
                    searchCol: opts.searchCol ?? current.searchCol,
                    sortColumn: opts.sortColumn ?? current.sortColumn,
                    sortDir: opts.sortDir ?? current.sortDir
                };
                window.location.href = buildUrl(params);
            }

            // Elements
            const searchInput = document.getElementById('searchBox');
            const searchField = document.getElementById('searchField');
            const pageSizeSelect = document.getElementById('pageSize');
            const paginationLinks = document.querySelectorAll('.pagination a.page-link');

            // Live search
            const onSearch = debounce(function (e) {
                const val = e.target.value.trim();
                navigateTo({
                    pageNumber: 1,
                    search: val,
                    searchCol: searchField.value
                });
            }, 450);

            if (searchInput) searchInput.addEventListener('input', onSearch);

            // search column change -> page 1
            if (searchField) searchField.addEventListener('change', function (e) {
                navigateTo({
                    pageNumber: 1,
                    search: searchInput.value.trim(),
                    searchCol: e.target.value
                });
            });

            // pageSize change -> page 1
            if (pageSizeSelect) pageSizeSelect.addEventListener('change', function (e) {
                navigateTo({
                    pageNumber: 1,
                    pageSize: parseInt(e.target.value, 10),
                    search: searchInput.value.trim()
                });
            });

            // pagination clicks
            document.querySelectorAll('.pagination a.page-link').forEach(function (el) {
                el.addEventListener('click', function (ev) {
                    ev.preventDefault();
                    const page = parseInt(el.getAttribute('data-page'), 10) || 1;
                    // clamp page
                    const target = Math.max(1, page);
                    navigateTo({
                        pageNumber: target,
                        pageSize: parseInt(pageSizeSelect.value, 10),
                        search: searchInput.value.trim()
                    });
                });
            });

            // Sorting: toggles direction; clicking a different column resets to ASC
            window.sortTable = function (column) {
                let newDir = current.sortDir === 'ASC' ? 'DESC' : 'ASC';
                if (current.sortColumn !== column) newDir = 'ASC';
                navigateTo({
                    pageNumber: 1,
                    sortColumn: column,
                    sortDir: newDir,
                    search: searchInput.value.trim()
                });
            };
        })();



      
    </script>

    <script src="~/js/rolecreation.js"></script>

}
