@model CoreOne.DOMAIN.Models.UserNotificationPagedResponse
@using CoreOne.DOMAIN.Models
@{
    ViewData["Title"] = "User Notification Master";
    Layout = "~/Views/Shared/_Layout.cshtml";

    int pageNumber = ViewBag.PageNumber ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int totalRecords = ViewBag.TotalRecords ?? 0;
    int totalPages = (int)Math.Ceiling(totalRecords / (double)pageSize);

    string search = ViewBag.Search ?? "";
    string sortColumn = ViewBag.SortColumn ?? "CreatedDateTime";
    string sortDir = ViewBag.SortDir ?? "DESC";
    string searchCol = ViewBag.SearchCol ?? "";

    var notifications = ViewBag.Notifications as List<UserNotificationDto> ?? new List<UserNotificationDto>();

    int maxWindow = 5;
    int startPage = Math.Max(1, pageNumber - maxWindow / 2);
    int endPage = Math.Min(totalPages, startPage + maxWindow - 1);
}
<link href="~/css/usernotifiaction.css" rel="stylesheet" />
<style>

    /* 🔄 Preloader Styles */
    #preloader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(13, 20, 35, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        transition: opacity 0.6s ease, visibility 0.6s ease;
    }

        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
        }

    .loader {
        text-align: center;
    }

        .loader .spin {
            font-size: 48px;
            color: #89a4cd;
            animation: spin 2s linear infinite;
        }

    .loading-text {
        color: #ffffffcc;
        margin-top: 10px;
        font-weight: 500;
        letter-spacing: 1px;
    }
    /* --- CLOSE BUTTON (modern glass look) --- */
    .btn-close-circle {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b6b, #ff3b3b);
      
        border-color: rgba(255,255,255,0.6);
        display: flex;
      
        
    }

        .btn-close-circle i {
            color: #ffffff;
            font-size: 13px;
          
        }

    /* Table base */
    .table {
        border-collapse: separate; /* needed for border-radius */
        border-spacing: 0; /* remove extra spacing */
        border-radius: 0.75rem; /* adjust radius as needed */
        overflow: hidden; /* ensures corners are rounded */
    }

        /* Table header */
        .table thead tr {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Table body rows */
        .table tbody tr {
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        /* Table cells */
        .table th,
        .table td {
            border: 1px solid #dcb20f; /* light gray borders */
            vertical-align: middle;
            padding: 0.75rem 1rem;
           
        }

        .table th {
            border: 1px solid #dcb20f; /* light gray borders */
            vertical-align: middle;
            font-size: 12px;
            padding: 0.75rem 1rem;
            background: #ffe57f;
        }

        /* Optional: round only top and bottom corners */
        .table thead tr:first-child th:first-child {
            border-top-left-radius: 0.75rem;
        }

        .table thead tr:first-child th:last-child {
            border-top-right-radius: 0.75rem;
        }

        .table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 0.75rem;
        }

        .table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 0.75rem;
        }

    /* === MODAL SIZE TWEAK === */
    .modal-dialog.modal-lg {
        max-width: 980px; /* Wider modal */
    }

    .modal-body {
        padding: 20px 24px !important; /* More breathing space */
    }

    /* === FORM ELEMENTS — SLIGHTLY LARGER === */
    .form-control-sm,
    .form-select-sm {
        font-size: 14px;
        padding: 5px 10px;
        height: 34px;
    }

    /* === TEXTAREA — SLIGHTLY TALLER === */
    textarea.form-control-sm {
        height: 70px;
    }

    /* === LABELS — MORE LEGIBLE === */
    .form-label {
        font-size: 13px;
        color: #495057;
    }

    /* === USER TAG AREA — NICER ALIGNMENT === */
    #selectedUsers {
        background: #fffaf0;
        border: 1px dashed #ecb95e;
        border-radius: 8px;
        padding: 6px 8px;
        min-height: 36px;
    }

    /* === USER PANEL HEIGHT FIX === */
    .col-md-6 .border.rounded-3.h-100 {
        min-height: 100%;
    }

</style>



<!-- 🔄 Preloader -->
<div id="preloader">
    <div class="loader">
        <i class="fas fa-globe logo-icon spin"></i>
        <div class="loading-text">Loading...</div>
    </div>
</div>

<div class="container-fluid  p-2" style="background:rgba(255, 255, 255, 0.08);">

    <div class="row" style="margin-top: -19px; margin-bottom: -6px;">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Check</a></li>
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Dashboard</a></li>

                    </ol>
                </div>
                <h4 class="page-title">User Notification</h4>
            </div>
        </div>
    </div>
    <div class="card" style="background:rgba(255, 255, 255, 0.08);border-radius: 9px; border: 1px solid #ffe16d; backdrop-filter: blur(12px);
                 -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
        <div class="card-body">
            <div class="row align-items-center p-2 mb-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #ffe16d; backdrop-filter: blur(12px);
                 -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
                <div class="row justify-content-between">

                    <div class="col-auto">
                        <button type="button" class="btn btn-blue waves-effect waves-light" style="background: linear-gradient(135deg, #8173fa, #5a48e5);border-radius: 11px;"
                                onclick="window.location.href='@Url.Action("UserNotification","Notification")'">
                            <i class="mdi mdi-refresh-circle"></i> Refresh
                        </button>
                    </div>



                    <div class="col-auto">
                        <button type="button" class="btn btn-success float-end" data-bs-toggle="modal" data-bs-target="#notificationBulkmodal" style="background: linear-gradient(135deg, #13dc72, #004993);    border-radius: 11px;">
                            <i class="mdi mdi-plus-circle"></i> Send Bulk Notification
                        </button>
                    </div>
                </div>

            </div>
            <div class="row align-items-center p-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #ffe16d; backdrop-filter: blur(12px); 
     -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">

                <div class="col-md-3">
                    <input type="search" id="searchBox" value="@search" class="form-control my-1 my-lg-0" placeholder="Search..." style="border-radius: 11px;  background: linear-gradient(135deg, #fffbf4, #ffffff);" />
                </div>
                <div class="col-md-2">
                    <select id="searchField" class="form-select my-1 my-lg-0t" style="  background: linear-gradient(135deg, #fffbf4, #ffffff);   border-radius: 11px;">
                        <option value="">All Columns</option>
                        <option value="UserName" selected="@(searchCol=="UserName")">User Name</option>
                        <option value="Title" selected="@(searchCol=="Title")">Title</option>
                        <option value="Message" selected="@(searchCol=="Message")">Message</option>
                        <option value="Type" selected="@(searchCol=="Type")">Type</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="btnSearch" class="btn btn-primary  my-1 my-lg-0" style="border-radius: 10px;"><i class="mdi mdi-magnify"></i> Search</button>
                </div>
                <div class="col-md-2 ms-auto d-flex justify-content-end" >
                    <select id="pageSize" class="form-select my-1 my-lg-0" style="border-radius: 11px; background: linear-gradient(135deg, #fffbf4, #ffffff);">
                        @{
                            int[] sizes = {1, 10, 20, 50, 100 };
                            foreach (var s in sizes)
                            {
                                <option value="@s" selected="@(s == pageSize)">@s</option>
                            }
                        }
                    </select>
                </div>
            

        </div>


            <div class="table-responsive row align-items-center p-2 mt-2 mb-2" style="background:rgba(255, 255, 255, 0.08); border-radius: 9px; border: 1px solid #ffe16d; backdrop-filter: blur(12px);
                 -webkit-backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); color: white;">
                <table class="table table-bordered table-hover table-sm mt-2">
                    <thead>
                        <tr style="background: #f3f7f9; color:black;">
                            <th style="color:black">Sl No.</th>

                            <th style="color:black">
                                <a href="javascript:void(0)" style="color:black" onclick="sortTable('UserName')" class="d-flex justify-content-between">
                                    User
                                    @(sortColumn == "UserName" ? (sortDir == "ASC" ? "↑" : "↓") : "↕")
                                </a>
                            </th>

                            <th style="color:black">
                                <a href="javascript:void(0)" style="color:black" onclick="sortTable('Title')" class="d-flex justify-content-between">
                                    Title
                                    @(sortColumn == "Title" ? (sortDir == "ASC" ? "↑" : "↓") : "↕")
                                </a>
                            </th>

                            <th style="color:black">
                                <a href="javascript:void(0)" style="color:black" onclick="sortTable('Message')" class="d-flex justify-content-between">
                                    Message
                                    @(sortColumn == "Message" ? (sortDir == "ASC" ? "↑" : "↓") : "↕")
                                </a>
                            </th>

                            <th style="color:black">
                                <a href="javascript:void(0)" style="color:black" onclick="sortTable('Type')" class="d-flex justify-content-between">
                                    Type
                                    @(sortColumn == "Type" ? (sortDir == "ASC" ? "↑" : "↓") : "↕")
                                </a>
                            </th>

                            <th style="color:black">
                                <a href="javascript:void(0)" style="color:black" onclick="sortTable('CreatedDateTime')" class="d-flex justify-content-between">
                                    Date
                                    @(sortColumn == "CreatedDateTime" ? (sortDir == "ASC" ? "↑" : "↓") : "↕")
                                </a>
                            </th>

                            <th style="color:black">Status</th>
                            <th style="color:black">Action</th>
                        </tr>
                    </thead>
                
                    <tbody>
                        @{
                            int count = (pageNumber - 1) * pageSize + 1;
                            foreach (var n in notifications)
                            {
                                <tr>
                                    <td>@count</td>
                                    <td class="text-body fw-semibold">@n.UserName</td>
                                    <td>@n.Title</td>
                                    <td>@n.Message</td>
                                    <td>@n.Type</td>
                                    <td>@n.CreatedDateTime?.ToString("dd-MM-yyyy")</td>
                                    <td>
                                        @if (n.IsRead)
                                        {
                                            <span class="badge bg-success">Read</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Unread</span>
                                        }
                                    </td>
                                    <td>
                                     <has-permission module-id="16" action-id="2">
                                        <!-- ✏️ Edit button -->
                                        <a href="javascript:;" class="action-icon" onclick="openEditUserNotifyModal(@n.NotificationID)">
                                            <i class="mdi mdi-square-edit-outline" data-toggle="tooltip" title="Edit" style="color:rebeccapurple"></i>
                                        </a>
                                        </has-permission>
                                        <script>
                                            async function openEditUserNotifyModal(notificationId) {
                                                console.log("🟦 Opening edit modal for:", notificationId);

                                                // Step 1: Open modal immediately
                                                const modalEl = document.getElementById('notificationModal');
                                                const modal = new bootstrap.Modal(modalEl);
                                                modal.show();

                                                // Step 2: Temporary loading state
                                                $('#notifyTitle, #notifyMessage, #notifyDropdown, #notifyStart, #notifyEnd').prop('disabled', true);
                                                $('#notifyTitle').val("Loading...");
                                                $('#notifyMessage').val("");
                                                $('#notifyDropdown').val("");
                                                $('#notifyStart').val("");
                                                $('#notifyEnd').val("");

                                                try {
                                                    // ✅ Fetch notification details
                                                    const response = await fetch(`/Notification/GetUserNotificationById?id=${notificationId}`);
                                                    if (!response.ok) throw new Error("Failed to fetch notification.");

                                                    const data = await response.json();
                                                    console.log("✅ Notification data:", data);

                                                    // Step 3: Fill modal fields
                                                    $('#notifyNotificationId').val(data.notificationID || 0);
                                                    $('#notifyUserId').val(data.userID || '');
                                                    $('#notifyTitle').val(data.title || '');
                                                    $('#notifyDropdown').val(data.notificationTypeID || '');
                                                    $('#notifyMessage').val(data.message || '');

                                                    // 🕓 Proper datetime-local formatting (no timezone shift)
                                                    $('#notifyStart').val(data.startDateTime ? formatLocalDateTime(data.startDateTime) : '');
                                                    $('#notifyEnd').val(data.endDateTime ? formatLocalDateTime(data.endDateTime) : '');

                                                } catch (err) {
                                                    console.error("❌ Error:", err);
                                                    $('#notifyTitle').val("Failed to load data.");
                                                } finally {
                                                    $('#notifyTitle, #notifyMessage, #notifyDropdown, #notifyStart, #notifyEnd').prop('disabled', false);
                                                }
                                            }

                                            /**
                                             * 🕒 formatLocalDateTime()
                                             * Converts backend datetime (with or without timezone)
                                             * to a format usable in <input type="datetime-local">
                                             *
                                             * Examples:
                                             *   "2025-11-02T16:06:00"  → "2025-11-02T16:06"
                                             *   "2025-11-02T16:06:00Z" → (local-adjusted) "2025-11-02T21:36" (if +05:30)
                                             */
                                            function formatLocalDateTime(dateString) {
                                                if (!dateString) return '';

                                                // 🟡 Case 1: Backend sends local time (no timezone, e.g. "2025-11-02T16:06:00")
                                                if (!dateString.endsWith('Z') && !dateString.includes('+')) {
                                                    const [datePart, timePart] = dateString.split('T');
                                                    const [hour, minute] = timePart.split(':');
                                                    return `${datePart}T${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
                                                }

                                                // 🟢 Case 2: Backend sends ISO UTC ("Z") or offset time
                                                const d = new Date(dateString);
                                                const pad = (n) => n.toString().padStart(2, '0');
                                                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                                            }
                                        </script>


                                            <has-permission module-id="16" action-id="4">
                                        <a href="javascript:;"
                                           class="action-icon"
                                           onclick="openEditUserNotifyModal(@n.NotificationID)
                                               $('#sendreminder').hide();">
                                            <i class="mdi mdi-eye-circle-outline" data-toggle="tooltip" title="View" style="color:#fd683b"></i>
                                        </a>
                                        </has-permission>
                                        <has-permission module-id="16" action-id="3">
                                            <a href="javascript:;" class="action-icon" onclick="DeleteUserNotifyModal(@n.NotificationID)">
                                                <i class="mdi mdi-delete" data-toggle="tooltip" title="Delete" style="color:red"></i>
                                            </a>

                                          

                                        </has-permission>
                                    </td>

                                </tr>
                                count++;
                            }

                            if (!notifications.Any())
                            {
                                <tr><td colspan="7" class="text-center text-muted">No records found</td></tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- 🔹 Pagination -->
            <nav>
                <ul class="pagination">
                    <li class="page-item @(pageNumber==1?"disabled":"")">
                        <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber - 1)">Prev</a>
                    </li>

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i==pageNumber?"active":"")">
                            <a class="page-link" href="javascript:void(0)" data-page="@i">@i</a>
                        </li>
                    }

                    <li class="page-item @(pageNumber>=totalPages?"disabled":"")">
                        <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber + 1)">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>




    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-bell-fill text-warning me-2"></i> Edit Notification
                </h5>
                <button type="button"
                        class="btn btn-light btn-close-circle shadow-sm"
                        onclick="window.location.href='@Url.Action("UserNotification","Notification")'">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="notifyNotificationId" />
                <input type="hidden" id="notifyUserId" />

                <div class="mb-2">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="notifyTitle" />
                </div>

                <div class="mb-2">
                    <label class="form-label">Notification Type</label>
                    <select id="notifyDropdown" name="notifyDropdown" class="form-select" asp-items="ViewBag.NotificationList">
                    </select>
                </div>

                <div class="mb-2">
                    <label class="form-label">Message</label>
                    <textarea class="form-control" id="notifyMessage" rows="3"></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Start Date & Time</label>
                        <input type="datetime-local" class="form-control" id="notifyStart" />
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">End Date & Time</label>
                        <input type="datetime-local" class="form-control" id="notifyEnd" />
                    </div>
                </div>
            </div>

         

            <div class="modal-footer border-0 pt-1 d-flex justify-content-between">
                <button type="button"
                        onclick="window.location.href='@Url.Action("UserNotification","Notification")'"
                        class="btn btn-warning btn-sm"
                        data-bs-dismiss="modal">
                    <i class="mdi mdi-close-circle-outline me-1"></i> Cancel
                </button>

                <button type="button" id="sendreminder" class="btn btn-sm" style="background:forestgreen; color:white" onclick="sendNotification()">
                    <i class="mdi mdi-content-save-outline me-1"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="notificationBulkmodal" tabindex="-1" aria-labelledby="notificationModalLabel" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow rounded-4 overflow-hidden">

            <!-- Header -->
            <div class="modal-header bg-light border-0 py-2 px-3">
                <h6 class="modal-title fw-semibold m-0">
                    <i class="bi bi-bell-fill text-warning me-2"></i> Send Bulk Notification
                </h6>
                <button type="button" class="btn btn-light btn-close-circle border-0 p-1"
                        onclick="window.location.href='/Notification/UserNotification'">
                    <i class="bi bi-x-lg small"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="modal-body bg-white p-3">
                <input type="hidden" id="notifyUserId" />
                <input type="hidden" id="notifyNotificationId" value="0" />

                <div class="row g-2">
                    <!-- Notification Section -->
                    <div class="col-md-6">
                        <div class="border rounded-3 p-2 bg-light shadow-sm-sm h-100">
                            <h6 class="fw-semibold text-secondary mb-2 pb-1 border-bottom small">
                                <i class="bi bi-card-text me-1 text-primary"></i> Notification
                            </h6>

                            <div class="mb-1">
                                <label class="form-label mb-0 small fw-semibold">Title</label>
                                <input type="text" class="form-control form-control-sm" id="notifyTitle" placeholder="Title..." />
                            </div>

                            <div class="mb-1">
                                <label class="form-label mb-0 small fw-semibold">Type</label>
                                <select id="notifyDropdown" name="notifyDropdown" class="form-select form-select-sm" asp-items="ViewBag.NotificationList"></select>
                            </div>

                            <div class="mb-1">
                                <label class="form-label mb-0 small fw-semibold">Message</label>
                                <textarea class="form-control form-control-sm" id="notifyMessage" rows="2" placeholder="Message..."></textarea>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-1">
                                    <label class="form-label mb-0 small fw-semibold">Start</label>
                                    <input type="datetime-local" class="form-control form-control-sm" id="notifyStart" />
                                </div>
                                <div class="col-6 mb-1">
                                    <label class="form-label mb-0 small fw-semibold">End</label>
                                    <input type="datetime-local" class="form-control form-control-sm" id="notifyEnd" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Selection Section -->
                    <!-- User Selection Section -->
                    <div class="col-md-6">
                        <div class="border rounded-3 p-2 bg-light shadow-sm-sm h-100">
                            <h6 class="fw-semibold text-secondary mb-2 pb-1 border-bottom small">
                                <i class="bi bi-search me-1 text-success"></i> Users
                            </h6>

                            <div class="position-relative">
                                <input type="text" id="searchUser" class="form-control form-control-sm" placeholder="Search user..." autocomplete="off" />
                                <ul id="userSuggestions"
                                    class="list-group position-absolute w-100 shadow rounded-3 mt-1 border-0"
                                    style="z-index: 1060; display: none; max-height: 160px; overflow-y: auto;"></ul>
                            </div>

                            <!-- 🧩 Moved below input -->
                            <div id="selectedUsers" class="d-flex flex-wrap gap-1 mt-2"></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0 py-2 px-3 d-flex justify-content-between bg-light">
                <button type="button"
                        onclick="window.location.href='/Notification/UserNotification'"
                        class="btn btn-outline-secondary btn-sm px-3 py-1">
                    <i class="mdi mdi-close-circle-outline me-1"></i> Cancel
                </button>
                <button type="button" id="sendreminder"
                        class="btn btn-send-green btn-sm px-3 py-1"
                        onclick="sendNotificationBulk()">
                    <i class="bi bi-send-fill me-1"></i> Send Notification
                </button>


            </div>
        </div>
    </div>
</div>

<style>
    /* === GREEN GRADIENT SEND BUTTON === */
    .btn-send-green {
        background: linear-gradient(90deg, #28a745, #20c997);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13.5px;
        letter-spacing: 0.3px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
        transition: all 0.25s ease;
    }

        .btn-send-green i {
            font-size: 15px;
            transition: transform 0.25s ease;
        }

        /* ✨ Hover & Active Effects */
        .btn-send-green:hover {
            background: linear-gradient(90deg, #28a745, #20c997);
            color: #fff;
            box-shadow: 0 3px 8px rgba(32, 201, 151, 0.4);
            transform: translateY(-1px);
        }

            .btn-send-green:hover i {
                transform: translateX(3px); /* subtle flying motion */
            }

        .btn-send-green:active {
            transform: scale(0.97);
        }


    /* --- Animation --- */
    .modal-content {
        animation: fadeInUp 0.25s ease;
        border-radius: 14px !important;
        overflow: hidden;
    }

    @@keyframes fadeInUp {
        from

    {
        transform: translateY(10px);
        opacity: 0;
    }

    to {
        transform: translateY(0);
        opacity: 1;
    }

    }

    /* --- HEADER --- */
    .modal-header {
        background: linear-gradient(90deg, #ec9e13, #fec764);
        color: #fff;
        padding: 8px 14px;
    }

        .modal-header .modal-title {
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        .modal-header .bi-bell-fill {
            color: #ffe57f !important;
        }

    .btn-close-circle i {
        color: #fff;
        opacity: 0.85;
        transition: 0.2s;
    }

    .btn-close-circle:hover i {
        opacity: 1;
        transform: scale(1.1);
    }

    /* --- BODY BACKGROUND --- */
    .modal-body {
        background: linear-gradient(180deg, #fffbf4 0%, #ffffff 100%);
        padding: 16px;
    }

    /* --- PANELS --- */
    .border.rounded-3 {
        background: linear-gradient(180deg, #ffffff 0%, #fff7e8 100%);
        border: 1px solid #ffe5b7 !important;
        transition: 0.2s;
    }

        .border.rounded-3:hover {
            box-shadow: 0 0 6px rgba(0, 123, 255, 0.2);
        }

    /* --- SECTION HEADERS --- */
    h6.fw-semibold.text-secondary {
        color: #cb8200 !important;
        background: linear-gradient(90deg, #ffe2ae, #fff3de);
        padding: 5px 8px;
        border-radius: 6px;
        font-size: 13px;
        letter-spacing: 0.2px;
    }

    /* --- INPUTS --- */
    .form-control-sm,
    .form-select-sm {
        font-size: 13px;
        padding: 4px 8px;
        height: 30px;
        border-radius: 6px;
        border: 1px solid #c9d6e0;
        transition: all 0.2s ease-in-out;
    }

        .form-control-sm:focus,
        .form-select-sm:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25);
        }

    textarea.form-control-sm {
        height: 60px;
        resize: none;
    }

    /* --- USER TAGS --- */
    .user-tag {
        background: linear-gradient(90deg, #007bff, #20c997);
        color: #fff;
        border-radius: 25px;
        padding: 3px 10px;
        display: flex;
        align-items: center;
        font-size: 12px;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        transition: 0.2s;
    }

        .user-tag:hover {
            transform: scale(1.05);
        }

        .user-tag .remove-user {
            background: transparent;
            border: none;
            color: #ffe57f;
            font-size: 13px;
            margin-left: 6px;
            cursor: pointer;
        }

            .user-tag .remove-user:hover {
                color: #ff4d4f;
            }

    /* --- SUGGESTION LIST --- */
    #userSuggestions {
        background: white;
        border-radius: 6px;
        overflow: hidden;
    }

        #userSuggestions li {
            cursor: pointer;
            border: none !important;
            padding: 7px 10px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
        }

            #userSuggestions li:hover {
                background: linear-gradient(90deg, #eaf7ff, #f3fff9);
            }

            #userSuggestions li .add-btn {
                background: linear-gradient(90deg, #198754, #20c997);
                border: none;
                padding: 3px 8px;
                font-size: 11px;
                color: white;
                border-radius: 4px;
                transition: 0.2s;
            }

                #userSuggestions li .add-btn:hover {
                    background: linear-gradient(90deg, #157347, #198754);
                }

    /* --- FOOTER --- */
    .modal-footer {
        background: linear-gradient(90deg, #f0f7ff, #eef9f3);
        border-top: 1px solid #dbe6f0 !important;
        padding: 8px 14px;
    }

    .btn-success {
        background: linear-gradient(90deg, #c28009, #eca424) !important;
        border: none;
        transition: 0.2s;
    }

        .btn-success:hover {
            background: linear-gradient(90deg, #c28009, #eca424) !important;
            transform: scale(1.02);
        }

    .btn-outline-secondary {
        border: 1px solid #adb5bd;
        background: linear-gradient(90deg, #fafafa, #f1f3f5);
        transition: 0.2s;
    }

        .btn-outline-secondary:hover {
            background: linear-gradient(90deg, #e9ecef, #dee2e6);
        }

    /* --- LIGHT SHADOW --- */
    .shadow-sm-sm {
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }
</style>



@section Scripts {


    <script>
             function openNotificationModal(userId, notificationId = 0, title = '', message = '', start = '', end = '', notificationTypeId = '') {
            $('#notifyUserId').val(userId);
            $('#notifyNotificationId').val(notificationId);

            $('#notifyTitle').val(title || '');
            $('#notifyMessage').val(message || '');
            $('#notifyStart').val(start ? start.replace('Z', '') : '');
            $('#notifyEnd').val(end ? end.replace('Z', '') : '');

            // 🟢 Now safely set dropdown
            $('#notifyDropdown').val(notificationTypeId || '');

            $('#notificationModal').modal('show');
        }



        $(document).on('change', '#notifyStart, #notifyEnd', function () {
            const start = $('#notifyStart').val();
            const end = $('#notifyEnd').val();

            if (start && end) {
                const startDate = parseLocalDateTime(start);
                const endDate = parseLocalDateTime(end);

                if (endDate.getTime() <= startDate.getTime()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Date Range',
                        text: 'End date/time must be later than the start date/time.',
                        confirmButtonColor: '#3085d6'
                    });
                    $('#notifyEnd').val('');
                }
            }
        });

        // ✅ Helper: Parse datetime-local without timezone offset
        function parseLocalDateTime(dateTimeString) {
            const [date, time] = dateTimeString.split('T');
            const [year, month, day] = date.split('-').map(Number);
            const [hour, minute] = time.split(':').map(Number);
            return new Date(year, month - 1, day, hour, minute);
        }


        // 🟢 Save notification (insert or update)
        async function sendNotification() {
            const userId = $('#notifyUserId').val();
            const notificationId = $('#notifyNotificationId').val() || 0;
            const title = $('#notifyTitle').val().trim();
            const message = $('#notifyMessage').val().trim();
            const startDateTime = $('#notifyStart').val();
            const endDateTime = $('#notifyEnd').val();
         const notificationTypeId = $('#notifyDropdown').val() || 0;


            // 🟡 Validate required fields
            if (!title || !message) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Fields',
                    text: 'Please enter both title and message.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            if (!startDateTime || !endDateTime) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Dates',
                    text: 'Please select both start and end date/time.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            const start = new Date(startDateTime);
            const end = new Date(endDateTime);

            // ✅ Strict check: end must be later than start
            if (end.getTime() <= start.getTime()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Invalid Dates',
                    text: 'End date/time must be later than the start date/time.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            // 🟢 Confirm before sending
            const confirmResult = await Swal.fire({
                title: 'Send Notification?',
                text: "Do you want to send this notification now?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Send it!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33'
            });

            if (!confirmResult.isConfirmed) return;

             const payload = {
            NotificationID: parseInt(notificationId),
            UserID: parseInt(userId),
            Title: title,
            Message: message,
            NotificationTypeID: parseInt(notificationTypeId),
            IsRead: 0,
            IsActive: 1,
            StartDateTime: startDateTime,
            EndDateTime: endDateTime,
            CreatedBy: 1,
            UpdatedBy: 1
        };


            try {
                const response = await fetch('/UserCreation/SaveUserNotification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sent!',
                        text: result.message || 'Notification sent successfully.',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = '/Notification/UserNotification';
                    });

                    $('#notificationModal').modal('hide');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message || 'Failed to send notification.',
                        confirmButtonColor: '#d33'
                    });
                }
            } catch (error) {
                console.error('Error sending notification:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong while sending notification.',
                    confirmButtonColor: '#d33'
                });
            }
        }
    </script>
    <script>



                function openEditModal(menuId) {
            fetch(`/ModuleSetup/GetMenuForEdit?id=${menuId}`)

                .then(res => res.ok ? res.json() : Promise.reject("Failed to load menu"))
                .then(data => {
                    if (!data) throw new Error("No data returned");

                    // Populate menu fields
                    $("#hdnMenuModuleID").val(data.menuID);
                    $("#MenuName").val(data.menuName);
                    $("#MenuSeq").val(data.menuSeq);
                    $("#MenuSymbol").val(data.menuSymbol);

                    const tbody = $("#moduleTable tbody").empty();

                    if (data.modules && data.modules.length > 0) {
                        // Sort modules by sequence ascending
                        const sortedModules = data.modules.sort((a, b) => a.sequence - b.sequence);

                        sortedModules.forEach(m => {
                            // Check for duplicate sequence in table
                            const seqExists = $("#moduleTable tbody tr").filter(function () {
                                return parseInt($(this).find(".moduleSeq input").val()) === m.sequence;
                            }).length > 0;

                            if (!seqExists) {
                                tbody.append(`
                                            <tr data-module-id="${m.moduleID}">
                                                <td class="moduleId" style="display:none">${m.moduleID}</td>
                                                <td class="moduleSeq">
                                                    <input type="number" class="form-control form-control-sm" value="${m.sequence}" />
                                                </td>
                                                <td class="moduleName">
                                                    <input type="text" class="form-control form-control-sm" value="${m.name}" />
                                                </td>
                                                <td class="moduleUrl">
                                                    <input type="text" class="form-control form-control-sm" value="${m.url}" />
                                                </td>
                                                 <td class="d-flex gap-1 justify-content-start">

                    <a href="javascript:void(0);"  onclick="ActionSetup('${m.moduleID}')" style="background: #f75964;color: white;" class="btn btn-sm setupModule" title="Setup"><i class="fe-command"></i></a>
                    </td>
                                            </tr>
                                        `);
                            }
                        });
                    }
                    $('#moduleModalLabel').text('Update Modules Setup :: Edit');
                    $('#moduleSetupModal').attr('aria-labelledby', 'moduleModalLabel');
                    $("#moduleSetupModal").modal("show");
                })
                .catch(err => alert(err));
        }
















        $(document).ready(function () {
            const current = {
                pageNumber: @pageNumber,
                pageSize: @pageSize,
                search: "@search",
                searchCol: "@searchCol",
                sortColumn: "@sortColumn",
                sortDir: "@sortDir"
            };

            function buildUrl(params) {
                const qs = new URLSearchParams();
                qs.set('pageNumber', params.pageNumber ?? 1);
                qs.set('pageSize', params.pageSize ?? current.pageSize);
                if ((params.search ?? '') !== '') qs.set('search', params.search ?? '');
                qs.set('searchCol', params.searchCol ?? current.searchCol);
                qs.set('sortColumn', params.sortColumn ?? current.sortColumn);
                qs.set('sortDir', params.sortDir ?? current.sortDir);
                return '@Url.Action("UserNotification", "Notification")' + '?' + qs.toString();
            }

            function navigateTo(opts) {
                const url = buildUrl(opts);
                console.log("➡ Navigating to:", url);
                window.location.href = url;
            }

            // 🔍 Search
            $(document).on('click', '#btnSearch', function () {
                const searchVal = $('#searchBox').val();
                const searchCol = $('#searchField').val();
                const pageSize = $('#pageSize').val();
                console.log("🔍 Search clicked:", searchVal, "Column:", searchCol);

                navigateTo({
                    pageNumber: 1,
                    search: searchVal,
                    searchCol: searchCol,
                    pageSize: parseInt(pageSize, 10),
                    sortColumn: current.sortColumn,
                    sortDir: current.sortDir
                });
            });

            // 🔁 Page Size Change
            $(document).on('change', '#pageSize', function () {
                navigateTo({
                    pageNumber: 1,
                    search: $('#searchBox').val(),
                    searchCol: $('#searchField').val(),
                    pageSize: parseInt($(this).val(), 10),
                    sortColumn: current.sortColumn,
                    sortDir: current.sortDir
                });
            });

            // 📄 Pagination
            $(document).on('click', '.pagination a.page-link', function (ev) {
                ev.preventDefault();
                const page = parseInt($(this).data('page'), 10);
                navigateTo({
                    pageNumber: page,
                    search: $('#searchBox').val(),
                    searchCol: $('#searchField').val(),
                    pageSize: parseInt($('#pageSize').val(), 10),
                    sortColumn: current.sortColumn,
                    sortDir: current.sortDir
                });
            });

            // ↕ Sorting
            window.sortTable = function (column) {
                const newDir = current.sortColumn === column && current.sortDir === 'ASC' ? 'DESC' : 'ASC';
                navigateTo({
                    pageNumber: 1,
                    search: $('#searchBox').val(),
                    searchCol: $('#searchField').val(),
                    pageSize: parseInt($('#pageSize').val(), 10),
                    sortColumn: column,
                    sortDir: newDir
                });
            };
        });
    </script>
 
    <script>
        
  function DeleteUserNotifyModal(NotificationID) {
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete massage`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                           $.ajax({
            url: '/Notification/DeleteUserNotification',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(NotificationID),
            success: function (resp) {
                if (resp.success) {
                    Swal.fire('Deleted!', resp.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Deleted!', resp.message, 'success').then(() => location.reload());
                }
            },
            error: function () {
                Swal.fire('Error!', 'Something went wrong.', 'error');
            }
        });

                }
            });
        }







    </script>

    <script>
        $(document).ready(function () {
            const $input = $('#searchUser');
            const $list = $('#userSuggestions');
            const $selectedUsers = $('#selectedUsers');
            const selectedUsers = [];

            // Autocomplete search
            $input.on('input', function () {
                const term = $(this).val().trim();
                if (term.length < 1) {
                    $list.hide();
                    return;
                }

                $.ajax({
                    url: '/Notification/SearchUserName',
                    type: 'GET',
                    data: { term: term },
                    success: function (data) {
                        $list.empty();

                        if (data && data.length > 0) {
                            // 🔥 Filter out already selected users
                            const filtered = data.filter(item => {
                                const id = item.userID || item.UserID;
                                return !selectedUsers.some(u => u.id === id);
                            });

                            if (filtered.length === 0) {
                                $list.hide();
                                return;
                            }

                            filtered.forEach(item => {
                                const userId = item.userID || item.UserID;
                                const userName = item.userName || item.UserName;

                                const li = $(`
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-person-circle text-primary me-2"></i>
                                            <strong>${userName}</strong>
                                        </div>
                                        <button class="add-btn">Add</button>
                                    </li>
                                `);

                                li.find('.add-btn').on('click', function (e) {
                                    e.stopPropagation();
                                    addUserTag(userId, userName);
                                    $input.val('');
                                    $list.hide();
                                });

                                li.on('click', function () {
                                    addUserTag(userId, userName);
                                    $input.val('');
                                    $list.hide();
                                });

                                $list.append(li);
                            });

                            $list.show();
                        } else {
                            $list.hide();
                        }
                    },
                    error: function () {
                        $list.hide();
                    }
                });
            });

            // Hide list when clicking outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#searchUser, #userSuggestions').length) {
                    $list.hide();
                }
            });

            // Add tag for selected user
            function addUserTag(userId, userName) {
                if (selectedUsers.some(u => u.id === userId)) return; // ✅ prevent duplicates

                selectedUsers.push({ id: userId, name: userName });

                const tag = $(`
                    <div class="user-tag" data-id="${userId}">
                        <i class="bi bi-person-fill me-1"></i>
                        ${userName}
                        <button type="button" class="remove-user" aria-label="Remove">&times;</button>
                    </div>
                `);

                tag.find('.remove-user').on('click', function () {
                    removeUserTag(userId);
                });

                $selectedUsers.append(tag);
                updateHiddenField();
            }

            // Remove tag
            function removeUserTag(userId) {
                const index = selectedUsers.findIndex(u => u.id === userId);
                if (index > -1) selectedUsers.splice(index, 1);
                $(`.user-tag[data-id="${userId}"]`).remove();
                updateHiddenField();
            }

            // Update hidden field with IDs
            function updateHiddenField() {
                const ids = selectedUsers.map(u => u.id);
                $('#notifyUserId').val(ids.join(','));
            }
        });
    </script>


    <script>
        // 🕒 Convert local datetime to UTC ISO
        function toIsoUtc(localDateTimeString) {
            if (!localDateTimeString) return null;
            const local = new Date(localDateTimeString);
            return new Date(local.getTime() - local.getTimezoneOffset() * 60000).toISOString();
        }

        // ✅ BULK SAVE
        async function sendNotificationBulk() {
            const userIds = $('#notifyUserId').val()?.split(',').map(id => parseInt(id)).filter(id => !isNaN(id)) || [];
               const $modal = $('#notificationBulkmodal'); // limit all queries to this modal

        const notificationId = $modal.find('#notifyNotificationId').val() || 0;
        const title = $modal.find('#notifyTitle').val().trim();
        const message = $modal.find('#notifyMessage').val().trim();
        const startDateTime = $modal.find('#notifyStart').val();
        const endDateTime = $modal.find('#notifyEnd').val();
        const notificationTypeId = $modal.find('#notifyDropdown').val() || 0;


            if (userIds.length === 0) {
                Swal.fire({ icon: 'warning', title: 'No User Selected', text: 'Please select at least one user.' });
                return;
            }
            if (!title || !message) {
                Swal.fire({ icon: 'warning', title: 'Missing Fields', text: 'Please enter both title and message.' });
                return;
            }
            if (!startDateTime || !endDateTime) {
                Swal.fire({ icon: 'warning', title: 'Missing Dates', text: 'Please select both start and end date/time.' });
                return;
            }

            const start = new Date(startDateTime);
            const end = new Date(endDateTime);
            if (end <= start) {
                Swal.fire({ icon: 'warning', title: 'Invalid Dates', text: 'End date/time must be later than start date/time.' });
                return;
            }

            const confirmResult = await Swal.fire({
                title: 'Send Notification?',
                text: `This will send the notification to ${userIds.length} users.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Send!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33'
            });
            if (!confirmResult.isConfirmed) return;

            // Build bulk payload (table-like array)
            const bulkData = userIds.map(uid => ({
                NotificationID: parseInt(notificationId),
                UserID: uid,
                Title: title,
                Message: message,
                NotificationTypeID: parseInt(notificationTypeId),
                IsRead: 0,
                IsActive: 1,
                StartDateTime: toIsoUtc(startDateTime),
                EndDateTime: toIsoUtc(endDateTime),
                CreatedBy: 1,
                UpdatedBy: 1
            }));

            Swal.fire({
                title: 'Sending...',
                html: `<p>Sending ${userIds.length} notifications. Please wait.</p>`,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch('/Notification/SaveUserNotificationBulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bulkData)
                });

                const result = await response.json();
                Swal.close();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => window.location.href = '/Notification/UserNotification');
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: result.message });
                }
            } catch (error) {
                Swal.close();
                Swal.fire({ icon: 'error', title: 'Error', text: 'Something went wrong while sending notifications.' });
                console.error('Bulk send error:', error);
            }
        }
    </script>






}
